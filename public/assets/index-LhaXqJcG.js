(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const u of r.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&s(u)}).observe(document,{childList:!0,subtree:!0});function o(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=o(i);fetch(i.href,r)}})();class x{constructor(e){this.state=e|0,this.state===0&&(this.state=19088743)}nextU32(){let e=this.state|0;return e^=e<<13,e^=e>>>17,e^=e<<5,this.state=e|0,e>>>0}nextFloat(){return this.nextU32()/4294967295}nextInt(e,o){const s=o-e;return s<=0?e:e+this.nextU32()%s}pickOne(e){return e[this.nextInt(0,e.length)]}}function q(t,e,o){return Math.max(e,Math.min(o,t))}function X(t,e){return{x:t.x+e.x,y:t.y+e.y}}function L(t,e){return Math.abs(t.x-e.x)+Math.abs(t.y-e.y)}function B(t){return`${t.x},${t.y}`}function K(t){const e=t.split(",");if(e.length!==2)return;const o=Number(e[0]),s=Number(e[1]);if(!(Number.isNaN(o)||Number.isNaN(s)))return{x:o,y:s}}function _(t,e,o){let s=t|0;return s^=e*374761393|0,s^=o*668265263|0,s=s^s>>>13|0,s=Math.imul(s,1274126177)|0,s^=s>>>16,s|0}const ve=1369555166,we=523124044,ke=2135587885,be=902013365,Se=1779033703,Ie=3144134277,xe=1013904242,$e=6,Te=22,Pe=48,Ae=128,Ee=9,Re=7,Me=4096;class J{constructor(e){this.seed=e|0}getTile(e,o){const s=this.sampleCoarse(ve,e,o,$e)&255;let i;if(s<Te?i="water":s<Pe?i="mountain":i=(this.sampleFine(we,e,o)&255)<Ae?"forest":"grass",i!=="water"&&i!=="mountain"&&(this.sampleCoarse(ke,e,o,Ee)&Re||(i="road")),i!=="water"&&i!=="mountain"){const r=this.sampleFine(be,e,o)%Me;r===0?i="town":r===1&&(i="dungeon")}return i}isWalkable(e){return!(e==="water"||e==="mountain")}movementCost(e){return e==="road"?1:e==="grass"||e==="town"||e==="dungeon"?1.4:e==="forest"?2.2:e==="mountain"||e==="water"?Number.POSITIVE_INFINITY:1.4}sampleFine(e,o,s){return _(this.seed^e|0,o,s)>>>0}sampleCoarse(e,o,s,i){const r=Math.floor(o/i),u=Math.floor(s/i);return this.sampleFine(e,r,u)}}function De(t,e,o){return ee("dungeon",t,e,o,Se)}function Z(t,e){return`${t}:L${e}`}function _e(t,e,o){return _(t^Ie|0,e,o)}function U(t,e,o){return ee("town",t,e,o,xe)}function ee(t,e,o,s,i){const u=(_(e^i|0,o,s)>>>0).toString(16).padStart(8,"0");return`${t}_${o}_${s}_${u}`}function S(t,e,o){return e*o+t}function Ce(t){return t==="floor"||t==="stairsUp"||t==="stairsDown"}function Fe(t){return t==="wall"}function P(t,e,o){return t.tiles[S(e,o,t.width)]}function D(t,e,o){return t.visibility[S(e,o,t.width)]}function qe(t,e,o,s){t.visibility[S(e,o,t.width)]=s}function Oe(t,e,o,s,i,r){const u=new x(s),l=new Array(i*r).fill("wall"),a=new Array(i*r).fill("unseen"),d=[];function c(k,f,w,b){for(let I=f;I<f+b;I++)for(let E=k;E<k+w;E++)l[S(E,I,i)]="floor"}function p(k,f){let w=k.x,b=k.y;if(u.nextInt(0,2)===0){for(;w!==f.x;)l[S(w,b,i)]="floor",w+=w<f.x?1:-1;for(;b!==f.y;)l[S(w,b,i)]="floor",b+=b<f.y?1:-1}else{for(;b!==f.y;)l[S(w,b,i)]="floor",b+=b<f.y?1:-1;for(;w!==f.x;)l[S(w,b,i)]="floor",w+=w<f.x?1:-1}l[S(w,b,i)]="floor"}const h=14;for(let k=0;k<h;k++){const f=u.nextInt(6,13),w=u.nextInt(5,11),b=u.nextInt(1,Math.max(2,i-f-1)),I=u.nextInt(1,Math.max(2,r-w-1));let E=!1;for(const R of d)if(b<R.x+R.w+1&&b+f+1>R.x&&I<R.y+R.h+1&&I+w+1>R.y){E=!0;break}if(E)continue;c(b,I,f,w);const Q={x:b+Math.floor(f/2),y:I+Math.floor(w/2)};d.push({x:b,y:I,w:f,h:w,center:Q}),d.length>1&&p(d[d.length-2].center,Q)}const v=d.length>0?d[0].center:{x:2,y:2},y=d.length>0?d[d.length-1].center:{x:i-3,y:r-3};l[S(v.x,v.y,i)]="stairsUp",l[S(y.x,y.y,i)]="stairsDown";const m=Ne(o);return{id:t,baseId:e,depth:o,theme:m,width:i,height:r,tiles:l,visibility:a,stairsUp:v,stairsDown:y}}function te(t,e){const o=new x(e);for(let s=0;s<2e3;s++){const i=o.nextInt(1,t.width-1),r=o.nextInt(1,t.height-1);if(t.tiles[S(i,r,t.width)]==="floor")return{x:i,y:r}}return{x:t.stairsDown.x,y:t.stairsDown.y}}function Ne(t){return t<3?"ruins":t<6?"caves":"crypt"}function Be(t,e){const o=[];let s=t.x,i=t.y;const r=e.x,u=e.y,l=Math.abs(r-s),a=Math.abs(u-i),d=s<r?1:-1,c=i<u?1:-1;let p=l-a;for(;o.push({x:s,y:i}),!(s===r&&i===u);){const h=2*p;h>-a&&(p-=a,s+=d),h<l&&(p+=l,i+=c)}return o}function ne(t){for(let e=0;e<t.visibility.length;e++)t.visibility[e]==="visible"&&(t.visibility[e]="seen")}function oe(t,e,o){const s=new Set,i=q(e.x-o,0,t.width-1),r=q(e.x+o,0,t.width-1),u=q(e.y-o,0,t.height-1),l=q(e.y+o,0,t.height-1),a=o*o;for(let d=u;d<=l;d++)for(let c=i;c<=r;c++){const p=c-e.x,h=d-e.y;if(p*p+h*h>a)continue;const v=Be(e,{x:c,y:d});for(let y=0;y<v.length;y++){const m=v[y];if(m.x<0||m.y<0||m.x>=t.width||m.y>=t.height)break;const k=`${m.x},${m.y}`;if(s.add(k),qe(t,m.x,m.y,"visible"),m.x===c&&m.y===d)break;const f=P(t,m.x,m.y);if(Fe(f)&&!(m.x===e.x&&m.y===e.y))break}}return s}function V(t,e,o,s){for(const i of t)if(!(i.mapRef.kind!=="dungeon"||i.mapRef.dungeonId!==o)&&i.pos.x===s.x&&i.pos.y===s.y&&i.hp>0)return i}function N(t,e){const o=t.getTile(e.x,e.y);return t.isWalkable(o)}function G(t,e){if(e.x<0||e.y<0||e.x>=t.width||e.y>=t.height)return!1;const o=P(t,e.x,e.y);return Ce(o)}function se(t,e,o,s,i=5e3){const r=B(t),u=B(e),l=new Set([r]),a=new Map,d=new Map;d.set(r,0);const c=new Map;c.set(r,L(t,e));let p=0;for(;l.size>0&&p<i;){p++;let h,v=Number.POSITIVE_INFINITY;for(const k of l){const f=c.get(k)??Number.POSITIVE_INFINITY;f<v&&(v=f,h=k)}if(!h)break;if(h===u)return Le(a,h);l.delete(h);const y=K(h);if(!y)break;const m=[{x:y.x+1,y:y.y},{x:y.x-1,y:y.y},{x:y.x,y:y.y+1},{x:y.x,y:y.y-1}];for(const k of m){if(!o(k))continue;const f=B(k);if(s(k)&&f!==u)continue;const w=(d.get(h)??Number.POSITIVE_INFINITY)+1,b=d.get(f)??Number.POSITIVE_INFINITY;w<b&&(a.set(f,h),d.set(f,w),c.set(f,w+L(k,e)),l.add(f))}}}function Le(t,e){const o=[e];for(;t.has(e);)e=t.get(e),o.push(e);o.reverse();const s=[];for(const i of o){const r=K(i);r&&s.push(r)}return s}function We(t,e,o,s){const i=se(t.pos,e.pos,r=>G(o,r),r=>!!V(s,"dungeon",o.id,r));if(!(!i||i.length<2))return i[1]}function He(t,e,o){const s=Math.floor(e/2),i=Math.floor(o/2),r=t.player.pos.x,u=t.player.pos.y;let l="";for(let a=-i;a<=i;a++){for(let d=-s;d<=s;d++){const c=r+d,p=u+a;if(d===0&&a===0){l+="@";continue}const h=Ye(t,c,p);if(h){l+=h;continue}const v=ze(t,c,p);if(v){l+=v;continue}if(t.mode==="overworld"){const y=t.overworld.getTile(c,p);l+=Ve(y)}else{const y=t.dungeon;if(!y){l+=" ";continue}if(c<0||p<0||c>=y.width||p>=y.height){l+=" ";continue}if(t.useFov&&D(y,c,p)==="unseen"){l+=" ";continue}l+=Ge(P(y,c,p))}}l+=`
`}return l}function Ye(t,e,o){for(const s of t.entities)if(s.kind==="monster"&&!(s.hp<=0)){if(t.mode==="overworld"){if(s.mapRef.kind!=="overworld")continue}else if(s.mapRef.kind!=="dungeon"||!t.dungeon||s.mapRef.dungeonId!==t.dungeon.id||t.useFov&&D(t.dungeon,e,o)!=="visible")continue;if(s.pos.x===e&&s.pos.y===o)return s.glyph}}function ze(t,e,o){for(const s of t.items)if(!(!s.mapRef||!s.pos)){if(t.mode==="overworld"){if(s.mapRef.kind!=="overworld")continue}else if(s.mapRef.kind!=="dungeon"||!t.dungeon||s.mapRef.dungeonId!==t.dungeon.id||t.useFov&&D(t.dungeon,e,o)!=="visible")continue;if(s.pos.x===e&&s.pos.y===o)return Ue(s.kind)}}function Ue(t){switch(t){case"potion":return"!";case"weapon":return")";case"armor":return"]";default:return"?"}}function Ve(t){switch(t){case"water":return"~";case"grass":return".";case"forest":return"♣";case"mountain":return"^";case"dungeon":return"D";case"town":return"T";case"road":return"=";default:return"?"}}function Ge(t){switch(t){case"wall":return"#";case"floor":return".";case"stairsUp":return"<";case"stairsDown":return">";default:return"?"}}class Qe{constructor(e){this.tileSize=e,this.sprites=new Map,this.buildAll()}get(e){const o=this.sprites.get(e);if(!o)throw new Error(`Missing sprite: ${e}`);return o}buildAll(){this.sprites.set("ow_water",this.make(e=>this.fill(e,"#0b355a","#0f4d7f"))),this.sprites.set("ow_grass",this.make(e=>this.fill(e,"#11402a","#1a5b3c"))),this.sprites.set("ow_forest",this.make(e=>this.patternForest(e))),this.sprites.set("ow_mountain",this.make(e=>this.patternMountain(e))),this.sprites.set("ow_road",this.make(e=>this.patternRoad(e))),this.sprites.set("ow_town",this.make(e=>this.patternTown(e))),this.sprites.set("ow_dungeon",this.make(e=>this.patternDungeonEntrance(e))),this.sprites.set("dg_wall_ruins",this.make(e=>this.patternStone(e,"#202a36","#2d3a4b"))),this.sprites.set("dg_floor_ruins",this.make(e=>this.patternFloor(e,"#0b1320","#0f1b2d"))),this.sprites.set("dg_stairs_ruins",this.make(e=>this.patternStairs(e,"#15243a","#cfe3ff"))),this.sprites.set("dg_wall_caves",this.make(e=>this.patternStone(e,"#1f2a20","#2c3a2e"))),this.sprites.set("dg_floor_caves",this.make(e=>this.patternFloor(e,"#0a130c","#122015"))),this.sprites.set("dg_stairs_caves",this.make(e=>this.patternStairs(e,"#17301a","#cfe3ff"))),this.sprites.set("dg_wall_crypt",this.make(e=>this.patternStone(e,"#2a1a2f","#3b2442"))),this.sprites.set("dg_floor_crypt",this.make(e=>this.patternFloor(e,"#120914","#1b0f1f"))),this.sprites.set("dg_stairs_crypt",this.make(e=>this.patternStairs(e,"#2c1231","#e6d7ff"))),this.sprites.set("ent_player",this.make(e=>this.glyph(e,"@","#ffffff"))),this.sprites.set("ent_slime",this.make(e=>this.glyph(e,"s","#7cff9e"))),this.sprites.set("ent_goblin",this.make(e=>this.glyph(e,"g","#7cff9e"))),this.sprites.set("ent_orc",this.make(e=>this.glyph(e,"O","#7cff9e"))),this.sprites.set("it_potion",this.make(e=>this.glyph(e,"!","#ffd36b"))),this.sprites.set("it_weapon",this.make(e=>this.glyph(e,")","#ffd36b"))),this.sprites.set("it_armor",this.make(e=>this.glyph(e,"]","#ffd36b"))),this.sprites.set("ui_path",this.make(e=>this.glyph(e,"•","#93a7c8"))),this.sprites.set("ui_destination",this.make(e=>this.glyph(e,"X","#ffffff")))}make(e){const o=document.createElement("canvas");o.width=this.tileSize,o.height=this.tileSize;const s=o.getContext("2d");if(!s)throw new Error("Canvas not available.");return s.imageSmoothingEnabled=!1,e(s),o}fill(e,o,s){e.fillStyle=o,e.fillRect(0,0,this.tileSize,this.tileSize),e.fillStyle=s;for(let i=0;i<10;i++){const r=i*7%this.tileSize,u=i*11%this.tileSize;e.fillRect(r,u,1,1)}}patternForest(e){this.fill(e,"#0e2a1b","#184a2f"),e.fillStyle="#1e6a45",e.fillRect(4,4,2,6),e.fillRect(10,3,2,7),e.fillStyle="#0b1320",e.fillRect(5,10,1,2),e.fillRect(11,10,1,2)}patternMountain(e){this.fill(e,"#3a3f46","#555b63"),e.fillStyle="#9aa1ab",e.beginPath(),e.moveTo(2,13),e.lineTo(7,4),e.lineTo(12,13),e.closePath(),e.fill()}patternRoad(e){this.fill(e,"#253041","#2f3f57"),e.fillStyle="#93a7c8";for(let o=2;o<this.tileSize-2;o+=3)e.fillRect(o,8,1,1)}patternTown(e){this.fill(e,"#2b3b58","#334a70"),e.fillStyle="#cfe3ff",e.fillRect(5,8,6,5),e.fillRect(6,6,4,2),e.fillStyle="#0b1320",e.fillRect(7,10,2,3)}patternDungeonEntrance(e){this.fill(e,"#553a8a","#6a4fb0"),e.fillStyle="#e6d7ff",e.fillRect(5,6,6,8),e.fillStyle="#120914",e.fillRect(6,8,4,6)}patternStone(e,o,s){this.fill(e,o,s),e.fillStyle=s,e.fillRect(2,3,5,2),e.fillRect(8,9,6,2)}patternFloor(e,o,s){this.fill(e,o,s),e.fillStyle=s,e.fillRect(4,4,1,1),e.fillRect(11,11,1,1)}patternStairs(e,o,s){this.fill(e,o,"#1a2433"),this.glyph(e,">",s)}glyph(e,o,s){e.fillStyle="rgba(0,0,0,0)",e.fillRect(0,0,this.tileSize,this.tileSize),e.fillStyle="rgba(0,0,0,0)",e.fillRect(0,0,this.tileSize,this.tileSize),e.fillStyle="rgba(0,0,0,0)",e.fillRect(0,0,this.tileSize,this.tileSize),e.fillStyle="rgba(0,0,0,0)",e.fillRect(0,0,this.tileSize,this.tileSize),e.fillStyle=s,e.font="12px monospace",e.textBaseline="top",e.fillText(o,5,2)}}class Xe{constructor(e){this.canvas=e;const o=e.getContext("2d");if(!o)throw new Error("Canvas 2D context not available.");this.ctx=o,this.ctx.font="12px monospace",this.atlas=new Qe(16)}render(e,o,s){const r=Math.floor(o/2),u=Math.floor(s/2),l=e.player.pos.x,a=e.player.pos.y;this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);for(let d=-u;d<=u;d++)for(let c=-r;c<=r;c++){const p=l+c,h=a+d,v=(c+r)*16,y=(d+u)*16;if(e.mode==="overworld"){const f=e.overworld.getTile(p,h);this.drawOverworldTile(f,v,y,16)}else{const f=e.dungeon;if(!f||p<0||h<0||p>=f.width||h>=f.height)continue;if(e.useFov){const w=D(f,p,h);if(w==="unseen")continue;w==="seen"?this.drawDungeonTile(f.theme,P(f,p,h),v,y,16,.35):this.drawDungeonTile(f.theme,P(f,p,h),v,y,16,1)}else this.drawDungeonTile(f.theme,P(f,p,h),v,y,16,1)}const m=this.findItemAt(e,p,h);m&&(this.ctx.fillStyle="#ffd36b",this.ctx.fillText(je(m.kind),v+5,y+12));const k=this.findMonsterAt(e,p,h);k&&(this.ctx.fillStyle="#7CFF9E",this.ctx.fillText(k.glyph,v+5,y+12)),c===0&&d===0&&(this.ctx.fillStyle="#FFFFFF",this.ctx.fillText("@",v+5,y+12))}}findMonsterAt(e,o,s){for(const i of e.entities)if(i.kind==="monster"&&!(i.hp<=0))if(e.mode==="overworld"){if(i.mapRef.kind!=="overworld")continue;if(i.pos.x===o&&i.pos.y===s)return i}else{if(!e.dungeon||i.mapRef.kind!=="dungeon"||i.mapRef.dungeonId!==e.dungeon.id||e.useFov&&D(e.dungeon,o,s)!=="visible")continue;if(i.pos.x===o&&i.pos.y===s)return i}}findItemAt(e,o,s){for(const i of e.items)if(!(!i.mapRef||!i.pos)){if(e.mode==="overworld"){if(i.mapRef.kind!=="overworld")continue}else if(!e.dungeon||i.mapRef.kind!=="dungeon"||i.mapRef.dungeonId!==e.dungeon.id||e.useFov&&D(e.dungeon,o,s)!=="visible")continue;if(i.pos.x===o&&i.pos.y===s)return i}}drawOverworldTile(e,o,s,i){const r=e==="water"?"ow_water":e==="grass"?"ow_grass":e==="forest"?"ow_forest":e==="mountain"?"ow_mountain":e==="road"?"ow_road":e==="town"?"ow_town":e==="dungeon"?"ow_dungeon":"ow_grass",u=this.atlas.get(r);this.ctx.drawImage(u,o,s,i,i)}drawDungeonTile(e,o,s,i,r,u){this.ctx.globalAlpha=u;const l=Ke(e);switch(o){case"wall":this.ctx.fillStyle=l.wall;break;case"floor":this.ctx.fillStyle=l.floor;break;case"stairsUp":this.ctx.fillStyle=l.stairs;break;case"stairsDown":this.ctx.fillStyle=l.stairs;break;default:this.ctx.fillStyle="#222";break}this.ctx.fillRect(s,i,r,r),this.ctx.globalAlpha=1,o==="stairsUp"&&(this.ctx.fillStyle=l.glyph,this.ctx.fillText("<",s+5,i+12)),o==="stairsDown"&&(this.ctx.fillStyle=l.glyph,this.ctx.fillText(">",s+5,i+12))}}function je(t){switch(t){case"potion":return"!";case"weapon":return")";case"armor":return"]";default:return"?"}}function Ke(t){switch(t){case"ruins":return{wall:"#202a36",floor:"#0b1320",stairs:"#15243a",glyph:"#cfe3ff"};case"caves":return{wall:"#1f2a20",floor:"#0a130c",stairs:"#17301a",glyph:"#cfe3ff"};case"crypt":return{wall:"#2a1a2f",floor:"#120914",stairs:"#2c1231",glyph:"#e6d7ff"};default:return{wall:"#1b2430",floor:"#0b1320",stairs:"#122033",glyph:"#cfe3ff"}}}class ie{constructor(e){this.max=e,this.items=[]}push(e){for(this.items.unshift({text:e,t:Date.now()});this.items.length>this.max;)this.items.pop()}all(){return[...this.items]}}const re="web-roguelike-starter-save-v3";function Je(t){const e=JSON.stringify(t);localStorage.setItem(re,e)}function Ze(){const t=localStorage.getItem(re);if(!t)return;const o=JSON.parse(t);if(!(!o||o.version!==3))return o}function et(t){return t.mode==="inventory"?tt(t.player,t.items):t.mode==="shop"?nt(t.player,t.items,t.activeShop,t.canShop,t.shopCategory):t.mode==="quest"?renderQuestLog(t.quests,t.activeTownId):'<div class="small muted">Panels: <b>I</b> inventory • <b>B</b> shop (in town) • <b>Q</b> quests (in town)</div>'}function tt(t,e){const o=t.inventory.map(a=>e.find(d=>d.id===a)).filter(a=>!!a),s=t.equipment.weaponItemId,i=t.equipment.armorItemId,r=s?e.find(a=>a.id===s):void 0,u=i?e.find(a=>a.id===i):void 0,l=[];if(l.push('<div class="panelTitle"><b>Inventory</b><span class="tag">I to close</span></div>'),l.push(`<div class="small">Gold: <b>${t.gold}</b> • Level: <b>${t.level}</b> • XP: <b>${t.xp}</b></div>`),l.push(`<div class="small">Weapon: ${r?`<b>${T(r.name)}</b>`:'<span class="muted">none</span>'}</div>`),l.push(`<div class="small">Armor: ${u?`<b>${T(u.name)}</b>`:'<span class="muted">none</span>'}</div>`),l.push('<div class="sep"></div>'),o.length===0)return l.push('<div class="small muted">Empty.</div>'),l.join("");l.push('<div class="grid">');for(const a of o.slice(0,60)){const d=a.kind==="potion"?`(+${a.healAmount??0} HP)`:a.kind==="weapon"?`(+${a.attackBonus??0} Atk)`:a.kind==="armor"?`(+${a.defenseBonus??0} Def)`:"",c=[];if(a.kind==="potion"&&c.push(`<button class="btnTiny" data-act="use" data-item="${a.id}">Use</button>`),a.kind==="weapon"){const p=t.equipment.weaponItemId,h=p?e.find(k=>k.id===p):void 0,v=(h==null?void 0:h.attackBonus)??0,m=(a.attackBonus??0)-v;c.push(`<button class="btnTiny" data-act="equipWeapon" data-item="${a.id}">Equip ${m===0?"":m>0?"(+"+m+")":"("+m+")"}</button>`)}if(a.kind==="armor"){const p=t.equipment.armorItemId,h=p?e.find(k=>k.id===p):void 0,v=(h==null?void 0:h.defenseBonus)??0,m=(a.defenseBonus??0)-v;c.push(`<button class="btnTiny" data-act="equipArmor" data-item="${a.id}">Equip ${m===0?"":m>0?"(+"+m+")":"("+m+")"}</button>`)}c.push(`<button class="btnTiny" data-act="drop" data-item="${a.id}">Drop</button>`),l.push(`<div class="small">• ${T(a.name)} <span class="muted">${T(d)}</span></div>`),l.push(`<div class="row" style="justify-content:flex-end;">${c.join("")}</div>`)}return l.push("</div>"),l.join("")}function nt(t,e,o,s,i){const r=[];if(r.push('<div class="panelTitle"><b>Town Shop</b><span class="tag">B to close</span></div>'),!s)return r.push('<div class="small muted">You need to be standing on a town tile (T) to shop.</div>'),r.join("");if(!o)return r.push('<div class="small muted">No shop found for this town.</div>'),r.join("");r.push(`<div class="small">Gold: <b>${t.gold}</b></div>`),r.push('<div class="row" style="margin-top:6px;"><button class="btnTiny" data-act="shopCat" data-cat="all">All</button><button class="btnTiny" data-act="shopCat" data-cat="potion">Potions</button><button class="btnTiny" data-act="shopCat" data-cat="weapon">Weapons</button><button class="btnTiny" data-act="shopCat" data-cat="armor">Armor</button></div>'),r.push('<div class="sep"></div>'),r.push('<div class="small muted">Buy</div>'),r.push('<div class="grid">');for(const l of o.stockItemIds.slice(0,40)){const a=e.find(p=>p.id===l);if(!a||i!=="all"&&a.kind!==i)continue;const d=a.value,c=a.kind==="potion"?`(+${a.healAmount??0} HP)`:a.kind==="weapon"?`(+${a.attackBonus??0} Atk)`:a.kind==="armor"?`(+${a.defenseBonus??0} Def)`:"";r.push(`<div class="small">• ${T(a.name)} <span class="muted">${T(c)}</span> <span class="muted">(${d}g)</span></div>`),r.push(`<div class="row" style="justify-content:flex-end;"><button class="btnTiny" data-act="buy" data-item="${a.id}">Buy</button></div>`)}r.push("</div>"),r.push('<div class="sep"></div>'),r.push('<div class="small muted">Sell (from inventory)</div>');const u=t.inventory.map(l=>e.find(a=>a.id===l)).filter(l=>!!l);if(u.length===0)return r.push('<div class="small muted">Nothing to sell.</div>'),r.join("");r.push('<div class="grid">');for(const l of u.slice(0,30)){const a=Math.max(1,Math.floor(l.value*.5));r.push(`<div class="small">• ${T(l.name)} <span class="muted">(${a}g)</span></div>`),r.push(`<div class="row" style="justify-content:flex-end;"><button class="btnTiny" data-act="sell" data-item="${l.id}">Sell</button></div>`)}return r.push("</div>"),r.join("")}function T(t){return t.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")}function ot(t,e,o){const s=Math.floor(e/2),i=Math.floor(o/2),r=t.player.pos.x,u=t.player.pos.y,l=new Set;if(t.autoPath)for(const d of t.autoPath)l.add(`${d.x},${d.y}`);let a="";for(let d=-i;d<=i;d++){for(let c=-s;c<=s;c++){const p=r+c,h=u+d;if(c===0&&d===0){a+="@";continue}if(t.destination&&t.destination.x===p&&t.destination.y===h){a+="X";continue}const v=`${p},${h}`;if(l.has(v)){a+="*";continue}const y=t.overworld.getTile(p,h);a+=st(y)}a+=`
`}return a}function st(t){switch(t){case"water":return"~";case"grass":return".";case"forest":return"♣";case"mountain":return"^";case"dungeon":return"D";case"town":return"T";case"road":return"=";default:return"?"}}const it=61,rt=33,M=document.getElementById("ascii"),O=document.getElementById("canvasWrap"),at=document.getElementById("modePill"),lt=document.getElementById("renderPill"),ut=document.getElementById("stats"),ae=document.getElementById("panel"),dt=document.getElementById("log"),ct=document.getElementById("btnAscii"),pt=document.getElementById("btnCanvas"),ft=document.getElementById("btnNewSeed"),ht=document.getElementById("btnSave"),yt=document.getElementById("btnLoad"),mt=document.getElementById("btnInv"),gt=document.getElementById("btnShop"),vt=document.getElementById("btnMap"),W=document.getElementById("gameCanvas"),wt=new Xe(W);function le(t){const e=new x(t),o=new J(t),s={id:"player",kind:"player",name:"You",glyph:"@",pos:kt(o,e),mapRef:{kind:"overworld"},hp:20,maxHp:20,baseAttack:2,baseDefense:0,level:1,xp:0,gold:20,inventory:[],equipment:{},statusEffects:[]},i={worldSeed:t,rng:e,mode:"overworld",overworld:o,dungeons:new Map,dungeonStack:[],player:s,entities:[s],items:[],shops:new Map,rendererMode:"ascii",useFov:!0,activePanel:"none",shopCategory:"all",turnCounter:0,quests:[],mapOpen:!1,mapCursor:{x:0,y:0},destination:void 0,autoPath:void 0,log:new ie(160)};return i.log.push("Welcome. Find a town (T) to shop or a dungeon (D) to descend."),i.log.push("I inventory • B shop (town) • Q quests (town) • G pick up items in dungeons."),i.log.push("P save • O load • R renderer • F FOV"),i}function kt(t,e){for(let o=0;o<4e3;o++){const s=e.nextInt(-200,200),i=e.nextInt(-200,200);if(N(t,{x:s,y:i}))return{x:s,y:i}}return{x:0,y:0}}let n=le(Date.now()&4294967295);function C(t){if(t.player.mapRef.kind==="dungeon")return t.dungeons.get(t.player.mapRef.dungeonId)}function ue(t,e,o,s){const i=Z(e,o),r=t.dungeons.get(i);if(r)return r;const l=_e(t.worldSeed,s.x,s.y)^o*2654435769|0,a=Oe(i,e,o,l,80,50);return bt(t,a,l),It(t,a,l),t.dungeons.set(i,a),a}function bt(t,e,o){const s=5+Math.min(12,e.depth*2),i=new x(o^48879);for(let r=0;r<s;r++){const u=te(e,o+1e3+r*17),l=i.nextInt(0,100),a=St(e.depth,l,t.rng,e.id,r,u);t.entities.push(a)}}function St(t,e,o,s,i,r){return e<35?{id:`m_${s}_${i}`,kind:"monster",name:"Slime",glyph:"s",pos:r,mapRef:{kind:"dungeon",dungeonId:s},hp:4+t,maxHp:4+t,baseAttack:1+Math.floor(t/2),baseDefense:0,level:1,xp:0,gold:0,inventory:[],equipment:{}}:e<75?{id:`m_${s}_${i}`,kind:"monster",name:"Goblin",glyph:"g",pos:r,mapRef:{kind:"dungeon",dungeonId:s},hp:6+t*2,maxHp:6+t*2,baseAttack:2+t,baseDefense:Math.floor(t/3),level:1,xp:0,gold:0,inventory:[],equipment:{}}:{id:`m_${s}_${i}`,kind:"monster",name:"Orc",glyph:"O",pos:r,mapRef:{kind:"dungeon",dungeonId:s},hp:10+t*3,maxHp:10+t*3,baseAttack:3+t,baseDefense:1+Math.floor(t/2),level:1,xp:0,gold:0,inventory:[],equipment:{},statusEffects:[]}}function It(t,e,o){const s=new x(o^335637),i=8;for(let r=0;r<i;r++){const u=te(e,o+5e3+r*31),l=s.nextInt(0,100);let a;l<55?a={id:`it_${e.id}_${r}`,kind:"potion",name:e.depth>=4?"Greater Healing Potion":"Healing Potion",healAmount:8+e.depth*2,mapRef:{kind:"dungeon",dungeonId:e.id},pos:u,value:10+e.depth*2}:l<85?a={id:`it_${e.id}_${r}`,kind:"weapon",name:e.depth>=4?"Iron Sword":"Rusty Sword",attackBonus:2+e.depth,mapRef:{kind:"dungeon",dungeonId:e.id},pos:u,value:18+e.depth*3}:a={id:`it_${e.id}_${r}`,kind:"armor",name:e.depth>=4?"Chain Vest":"Leather Armor",defenseBonus:1+Math.floor(e.depth/2),mapRef:{kind:"dungeon",dungeonId:e.id},pos:u,value:18+e.depth*3},t.items.push(a)}}function de(){if(!(n.mode!=="overworld"||n.overworld.getTile(n.player.pos.x,n.player.pos.y)!=="town"))return U(n.worldSeed,n.player.pos.x,n.player.pos.y)}function H(t,e){const o=U(t.worldSeed,e.x,e.y);if(t.quests.some(u=>u.townId===o))return;const s=_(t.worldSeed,e.x,e.y)^659918,i=new x(s),r=1+i.nextInt(0,2);for(let u=0;u<r;u++){const l=1+i.nextInt(0,4),a=6+i.nextInt(0,8),d=20+l*10+i.nextInt(0,10),c=18+l*8+i.nextInt(0,10),p={id:`q_${o}_${u}`,townId:o,kind:"killMonsters",description:`Clear threats: defeat ${a} monsters (depth ≥ ${l})`,targetCount:a,currentCount:0,minDungeonDepth:l,rewardGold:d,rewardXp:c,completed:!1,turnedIn:!1};t.quests.push(p)}}function xt(t,e){for(const o of t.quests)o.kind==="killMonsters"&&(o.completed||o.turnedIn||e<o.minDungeonDepth||(o.currentCount+=1,o.currentCount>=o.targetCount&&(o.currentCount=o.targetCount,o.completed=!0,t.log.push(`Quest complete: ${o.description}. Return to town to turn in (Q).`))))}function $t(t){const e=t.player.statusEffects??[];if(e.length!==0){for(const o of e)o.kind==="poison"&&(t.player.hp-=o.potency,t.log.push(`Poison deals ${o.potency} damage. (${Math.max(0,t.player.hp)}/${t.player.maxHp})`)),o.remainingTurns-=1;t.player.statusEffects=e.filter(o=>o.remainingTurns>0),t.player.hp<=0&&t.log.push("You succumb to your wounds.")}}function Tt(t){if(t.name!=="Slime"||n.rng.nextInt(0,100)>=20)return;const o=n.player.statusEffects??[],s=o.find(i=>i.kind==="poison");s?(s.remainingTurns=Math.max(s.remainingTurns,5),s.potency=Math.max(s.potency,1)):o.push({kind:"poison",remainingTurns:5,potency:1}),n.player.statusEffects=o,n.log.push("You are poisoned!")}function Y(t,e){if(!(t.turnCounter%80===0))return;const i=_(t.worldSeed,e.townWorldPos.x,e.townWorldPos.y)^Math.floor(t.turnCounter/80)*2654435769,r=new x(i),u=new Set(e.stockItemIds);t.items=t.items.filter(a=>!u.has(a.id));const l=[];for(let a=0;a<10;a++){const d=r.nextInt(0,100),c=`shop_${e.id}_${Math.floor(t.turnCounter/80)}_${a}`;let p;d<45?p={id:c,kind:"potion",name:"Healing Potion",healAmount:10,value:14}:d<75?p={id:c,kind:"weapon",name:"Steel Dagger",attackBonus:3,value:30}:p={id:c,kind:"armor",name:"Padded Vest",defenseBonus:2,value:28},t.items.push(p),l.push(c)}e.stockItemIds=l,t.log.push("The shop has new stock.")}function F(t,e){const o=U(t.worldSeed,e.x,e.y),s=t.shops.get(o);if(s)return s;const i=[],r=_(t.worldSeed,e.x,e.y),u=new x(r^12648430);for(let a=0;a<10;a++){const d=u.nextInt(0,100),c=`shop_${o}_${a}`;let p;d<45?p={id:c,kind:"potion",name:"Healing Potion",healAmount:10,value:14}:d<75?p={id:c,kind:"weapon",name:"Steel Dagger",attackBonus:3,value:30}:p={id:c,kind:"armor",name:"Padded Vest",defenseBonus:2,value:28},t.items.push(p),i.push(c)}const l={id:o,townWorldPos:{x:e.x,y:e.y},stockItemIds:i};return t.shops.set(o,l),l}function $(){return n.mode==="overworld"&&n.overworld.getTile(n.player.pos.x,n.player.pos.y)==="town"}function Pt(){return n.mode==="overworld"&&n.overworld.getTile(n.player.pos.x,n.player.pos.y)==="dungeon"}function At(t){t.entities=t.entities.filter(e=>e.hp>0||e.kind==="player")}function ce(t){if(t.kind==="toggleRenderer"){n.rendererMode=n.rendererMode==="ascii"?"canvas":"ascii",A(),g();return}if(t.kind==="toggleFov"){n.useFov=!n.useFov,n.log.push(n.useFov?"FOV enabled.":"FOV disabled."),g();return}if(t.kind==="toggleInventory"){n.activePanel=n.activePanel==="inventory"?"none":"inventory",g();return}if(t.kind==="toggleShop"){if(n.activePanel=n.activePanel==="shop"?"none":"shop",n.activePanel==="shop"&&$()){F(n,n.player.pos),H(n,n.player.pos);const o=F(n,n.player.pos);Y(n,o)}g();return}if(t.kind==="toggleMap"){if(n.mode!=="overworld"){n.log.push("Map is only available on the overworld."),g();return}n.mapOpen=!n.mapOpen,n.activePanel="none",n.mapCursor={x:0,y:0},n.mapOpen&&n.log.push("Map open: move cursor with WASD/Arrows, Enter to set destination, Esc/M to close, C to cancel auto-walk."),g();return}if(t.kind==="cancelAuto"){n.destination=void 0,n.autoPath=void 0,n.log.push("Auto-walk canceled."),g();return}if(t.kind==="toggleQuest"){if(n.activePanel=n.activePanel==="quest"?"none":"quest",n.activePanel==="quest"&&$()){H(n,n.player.pos);const o=F(n,n.player.pos);Y(n,o)}g();return}if(t.kind==="save"){me(),g();return}if(t.kind==="load"){ge(),A(),g();return}if(t.kind==="help"){n.log.push("Keys: WASD/Arrows move • Shift+Move run (overworld) • M map • Enter use • I inventory • B shop (town) • Q quests (town) • G pick up • R renderer • F FOV • P save • O load."),g();return}if(n.turnCounter+=1,$t(n),n.player.hp<=0){g();return}if(!Et(t)){g();return}Dt(),At(n),n.player.hp<=0&&n.log.push("You died. Press New Seed to restart."),g()}function Et(t){if(n.player.hp<=0)return!1;if(n.mode==="overworld"&&n.autoPath&&n.autoPath.length>=2&&(t.kind==="move"||t.kind==="wait")){const e=n.autoPath[1];if(!N(n.overworld,e))return n.log.push("Auto-walk blocked."),n.destination=void 0,n.autoPath=void 0,!1;n.player.pos={x:e.x,y:e.y},n.autoPath=n.autoPath.slice(1),n.destination&&n.player.pos.x===n.destination.x&&n.player.pos.y===n.destination.y&&(n.log.push("Arrived at destination."),n.destination=void 0,n.autoPath=void 0);const o=n.overworld.getTile(n.player.pos.x,n.player.pos.y);return o==="dungeon"&&n.log.push("Dungeon entrance found. Press Enter to enter."),o==="town"&&n.log.push("Town found. Press Enter then B/Q."),!0}if(t.kind==="wait")return n.log.push("You wait."),!0;if(t.kind==="pickup")return Rt();if(t.kind==="use"){if(n.mode==="overworld")return Pt()?(_t(n.player.pos),!0):$()?(n.log.push("You're in town. Press B to open the shop."),!0):(n.log.push("Nothing to use here."),!1);{const e=C(n);if(!e)return!1;const o=P(e,n.player.pos.x,n.player.pos.y);return o==="stairsUp"?(Ft(),!0):o==="stairsDown"?(Ct(),!0):(n.log.push("Nothing to use here."),!1)}}return t.kind==="move"?Mt(t.dx,t.dy):!1}function Rt(){const t=C(n);if(n.mode!=="dungeon"||!t)return n.log.push("You can only pick up items inside dungeons (for now)."),!1;for(const e of n.items)if(!(!e.mapRef||!e.pos)&&e.mapRef.kind==="dungeon"&&e.mapRef.dungeonId===t.id&&e.pos.x===n.player.pos.x&&e.pos.y===n.player.pos.y)return e.mapRef=void 0,e.pos=void 0,n.player.inventory.push(e.id),n.log.push(`Picked up: ${e.name}.`),!0;return n.log.push("Nothing to pick up."),!1}function Mt(t,e){const o=X(n.player.pos,{x:t,y:e});if(n.mode==="dungeon"){const l=C(n);if(!l)return!1;const a=V(n.entities,"dungeon",l.id,o);return a&&a.kind==="monster"?(ye(n.player,a),!0):G(l,o)?(n.player.pos=o,!0):!1}const s=Math.max(Math.abs(t),Math.abs(e)),i=t===0?0:t>0?1:-1,r=e===0?0:e>0?1:-1;let u=!1;for(let l=0;l<s;l++){const a=X(n.player.pos,{x:i,y:r});if(!N(n.overworld,a))break;n.player.pos=a,u=!0,n.destination=void 0,n.autoPath=void 0;const d=n.overworld.getTile(a.x,a.y);d==="dungeon"&&n.log.push("Dungeon entrance found. Press Enter to enter."),d==="town"&&n.log.push("Town found. Press Enter then B/Q.")}return u}function pe(t){const e=t.equipment.weaponItemId;if(!e)return 0;const o=n.items.find(s=>s.id===e);return(o==null?void 0:o.attackBonus)??0}function fe(t){const e=t.equipment.armorItemId;if(!e)return 0;const o=n.items.find(s=>s.id===e);return(o==null?void 0:o.defenseBonus)??0}function he(t){for(n.player.xp+=t;n.player.xp>=z(n.player.level);)n.player.xp-=z(n.player.level),n.player.level+=1,n.player.maxHp+=5,n.player.hp=n.player.maxHp,n.player.baseAttack+=1,n.player.level%2===0&&(n.player.baseDefense+=1),n.log.push(`*** Level up! You are now level ${n.player.level}. ***`)}function z(t){return 25+(t-1)*12}function ye(t,e){var l;const o=t.baseAttack+pe(t),s=e.baseDefense+fe(e),i=n.rng.nextInt(0,5),r=o+i,u=Math.max(1,r-s);if(e.hp-=u,n.log.push(`${t.name} hits ${e.name} for ${u}. (${Math.max(0,e.hp)}/${e.maxHp})`),e.hp<=0&&(n.log.push(`${e.name} dies.`),t.kind==="player")){const a=6+(e.baseAttack+e.baseDefense),d=2+n.rng.nextInt(0,4);n.player.gold+=d,n.log.push(`You gain ${a} XP and loot ${d} gold.`),he(a);const c=((l=n.dungeonStack[n.dungeonStack.length-1])==null?void 0:l.depth)??0;xt(n,c)}}function Dt(){if(n.mode!=="dungeon")return;const t=C(n);if(!t)return;let e;n.useFov&&(ne(t),e=oe(t,n.player.pos,10));for(const o of n.entities){if(o.kind!=="monster"||o.hp<=0||o.mapRef.kind!=="dungeon"||o.mapRef.dungeonId!==t.id)continue;const s=L(o.pos,n.player.pos);if(s<=1){const r=n.player.hp;ye(o,n.player),n.player.hp<r&&n.player.hp>0&&Tt(o);continue}const i=!n.useFov||(e?e.has(`${o.pos.x},${o.pos.y}`):!0);if(s<=12&&i){const r=We(o,n.player,t,n.entities);if(!r||V(n.entities,"dungeon",t.id,r))continue;G(t,r)&&(o.pos=r)}}}function _t(t){const e=De(n.worldSeed,t.x,t.y),o=0,s=ue(n,e,o,t);n.dungeonStack=[{baseId:e,depth:o,entranceWorldPos:{x:t.x,y:t.y}}],n.mode="dungeon",n.player.mapRef={kind:"dungeon",dungeonId:s.id},n.player.pos={x:s.stairsUp.x,y:s.stairsUp.y},n.log.push("You enter the dungeon.")}function Ct(){const t=n.dungeonStack[n.dungeonStack.length-1];if(!t)return;const e=t.depth+1,o=ue(n,t.baseId,e,t.entranceWorldPos);n.dungeonStack.push({baseId:t.baseId,depth:e,entranceWorldPos:t.entranceWorldPos}),n.player.mapRef={kind:"dungeon",dungeonId:o.id},n.player.pos={x:o.stairsUp.x,y:o.stairsUp.y},n.log.push(`You descend to depth ${e}. Theme: ${o.theme}.`)}function Ft(){if(n.dungeonStack.length<=1){const s=n.dungeonStack[0];if(!s)return;n.mode="overworld",n.player.mapRef={kind:"overworld"},n.player.pos={x:s.entranceWorldPos.x,y:s.entranceWorldPos.y},n.dungeonStack=[],n.log.push("You return to the overworld.");return}n.dungeonStack.pop();const t=n.dungeonStack[n.dungeonStack.length-1],e=Z(t.baseId,t.depth),o=n.dungeons.get(e);o&&(n.player.mapRef={kind:"dungeon",dungeonId:e},n.player.pos={x:o.stairsDown.x,y:o.stairsDown.y},n.log.push(`You ascend to depth ${t.depth}.`))}function qt(t){if(n.mode!=="overworld")return;const e=se(n.player.pos,t,o=>N(n.overworld,o),o=>!1,2e4);if(!e||e.length<2){n.log.push("No path found to destination."),n.destination=void 0,n.autoPath=void 0;return}n.destination=t,n.autoPath=e,n.log.push(`Auto-walk set: ${t.x}, ${t.y}. Press any move/space to advance, or C to cancel.`)}function A(){const t=n.rendererMode==="ascii";M.style.display=t?"block":"none",O.style.display=t?"none":"block"}function g(){var r;const t=C(n);at.textContent=n.mode==="overworld"?"Mode: overworld":`Mode: dungeon (depth ${((r=n.dungeonStack[n.dungeonStack.length-1])==null?void 0:r.depth)??0} • ${(t==null?void 0:t.theme)??"?"})`,lt.textContent=`Renderer: ${n.rendererMode} • FOV: ${n.useFov?"on":"off"}`,n.mode==="dungeon"&&t&&n.useFov&&(ne(t),oe(t,n.player.pos,10));const e=n.player.baseAttack+pe(n.player),o=n.player.baseDefense+fe(n.player);ut.innerHTML=`
    <div class="kv"><div><b>${j(n.player.name)}</b> <span class="muted">Lvl ${n.player.level}</span></div><div>HP ${n.player.hp}/${n.player.maxHp}</div></div>
    <div class="kv small"><div>Atk ${e}</div><div>Def ${o}</div></div>
    <div class="kv small"><div>XP ${n.player.xp}/${z(n.player.level)}</div><div>Gold ${n.player.gold}</div></div>
    <div class="kv small"><div>Pos ${n.player.pos.x}, ${n.player.pos.y}</div><div class="muted">Turn ${n.turnCounter}</div></div>
    <div class="kv small"><div class="muted">Status ${(n.player.statusEffects??[]).map(u=>u.kind+":"+u.remainingTurns).join(", ")||"none"}</div><div class="muted">Seed ${n.worldSeed}</div></div>
  `;const s=$()?F(n,n.player.pos):void 0;s&&(H(n,n.player.pos),Y(n,s));const i=de();if(ae.innerHTML=et({mode:n.activePanel,player:n.player,items:n.items,activeShop:s,canShop:$(),quests:n.quests,activeTownId:i,shopCategory:n.shopCategory}),dt.innerHTML=n.log.all().slice(0,160).map(u=>`<div>• ${j(u.text)}</div>`).join(""),n.mapOpen){M.style.display="block",O.style.display="none";const u=n.destination??{x:n.player.pos.x+n.mapCursor.x,y:n.player.pos.y+n.mapCursor.y};M.textContent=ot({overworld:n.overworld,player:n.player,destination:u,autoPath:n.autoPath,items:n.items},89,41);return}n.rendererMode==="ascii"?(M.style.display="block",O.style.display="none",M.textContent=He({mode:n.mode,overworld:n.overworld,dungeon:t,player:n.player,entities:n.entities,items:n.items,useFov:n.useFov},it,rt)):(M.style.display="none",O.style.display="block",wt.render({mode:n.mode,overworld:n.overworld,dungeon:t,player:n.player,entities:n.entities,items:n.items,useFov:n.useFov},Math.floor(W.width/16)-1,Math.floor(W.height/16)-1))}ae.addEventListener("click",t=>{const e=t.target;if(!e)return;const o=e.getAttribute("data-act"),s=e.getAttribute("data-item"),i=e.getAttribute("data-quest");if(o){if(o==="use"){if(!s)return;Ot(s),g();return}if(o==="equipWeapon"){if(!s)return;Nt(s),g();return}if(o==="equipArmor"){if(!s)return;Bt(s),g();return}if(o==="drop"){if(!s)return;Lt(s),g();return}if(o==="buy"){if(!s)return;Wt(s),g();return}if(o==="sell"){if(!s)return;Ht(s),g();return}if(o==="shopCat"){const r=e.getAttribute("data-cat");(r==="all"||r==="potion"||r==="weapon"||r==="armor")&&(n.shopCategory=r),g();return}if(o==="turnIn"){i&&Yt(i),g();return}}});function Ot(t){const e=n.items.find(i=>i.id===t);if(!e||e.kind!=="potion"||!n.player.inventory.includes(t))return;const o=e.healAmount??8,s=n.player.hp;n.player.hp=Math.min(n.player.maxHp,n.player.hp+o),n.player.inventory=n.player.inventory.filter(i=>i!==t),n.items=n.items.filter(i=>i.id!==t),n.log.push(`You drink ${e.name}. (+${n.player.hp-s} HP)`)}function Nt(t){const e=n.items.find(o=>o.id===t);!e||e.kind!=="weapon"||n.player.inventory.includes(t)&&(n.player.equipment.weaponItemId=t,n.log.push(`Equipped weapon: ${e.name}.`))}function Bt(t){const e=n.items.find(o=>o.id===t);!e||e.kind!=="armor"||n.player.inventory.includes(t)&&(n.player.equipment.armorItemId=t,n.log.push(`Equipped armor: ${e.name}.`))}function Lt(t){const e=n.items.find(o=>o.id===t);if(e&&n.player.inventory.includes(t)){if(n.mode==="dungeon"){const o=C(n);o&&(e.mapRef={kind:"dungeon",dungeonId:o.id},e.pos={x:n.player.pos.x,y:n.player.pos.y},n.log.push(`Dropped: ${e.name}.`))}else n.log.push(`Discarded: ${e.name}.`),n.items=n.items.filter(o=>o.id!==t);n.player.inventory=n.player.inventory.filter(o=>o!==t),n.player.equipment.weaponItemId===t&&(n.player.equipment.weaponItemId=void 0),n.player.equipment.armorItemId===t&&(n.player.equipment.armorItemId=void 0)}}function Wt(t){if(!$()){n.log.push("You need to be in town to buy.");return}const e=n.items.find(s=>s.id===t);if(!e)return;const o=e.value;if(n.player.gold<o){n.log.push("Not enough gold.");return}n.player.gold-=o,n.player.inventory.push(e.id),n.log.push(`Bought: ${e.name} for ${o}g.`)}function Ht(t){if(!$()){n.log.push("You need to be in town to sell.");return}const e=n.items.find(s=>s.id===t);if(!e||!n.player.inventory.includes(t))return;const o=Math.max(1,Math.floor(e.value*.5));n.player.gold+=o,n.player.inventory=n.player.inventory.filter(s=>s!==t),n.player.equipment.weaponItemId===t&&(n.player.equipment.weaponItemId=void 0),n.player.equipment.armorItemId===t&&(n.player.equipment.armorItemId=void 0),n.items=n.items.filter(s=>s.id!==t),n.log.push(`Sold: ${e.name} for ${o}g.`)}function Yt(t){const e=de();if(!e){n.log.push("You need to be in town to turn in quests.");return}const o=n.quests.find(s=>s.id===t);if(o){if(o.townId!==e){n.log.push("That quest belongs to another town.");return}if(!o.turnedIn){if(!o.completed){n.log.push("Quest is not complete yet.");return}o.turnedIn=!0,n.player.gold+=o.rewardGold,he(o.rewardXp),n.log.push(`Quest turned in! +${o.rewardGold}g and +${o.rewardXp} XP.`)}}}function j(t){return t.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")}function zt(t){if(t.key==="r"||t.key==="R")return{kind:"toggleRenderer"};if(t.key==="f"||t.key==="F")return{kind:"toggleFov"};if(t.key==="?")return{kind:"help"};if(t.key==="p"||t.key==="P")return{kind:"save"};if(t.key==="o"||t.key==="O")return{kind:"load"};if(t.key==="i"||t.key==="I")return{kind:"toggleInventory"};if(t.key==="b"||t.key==="B")return{kind:"toggleShop"};if(t.key==="q"||t.key==="Q")return{kind:"toggleQuest"};if(t.key==="m"||t.key==="M")return{kind:"toggleMap"};if(t.key==="g"||t.key==="G"||t.key===",")return{kind:"pickup"};if(t.key==="Enter")return{kind:"use"};if(t.key==="c"||t.key==="C")return{kind:"cancelAuto"};if(t.key===" ")return{kind:"wait"};if(t.key==="ArrowUp"||t.key==="w"||t.key==="W")return{kind:"move",dx:0,dy:-1*(t.shiftKey?5:1)};if(t.key==="ArrowDown"||t.key==="s"||t.key==="S")return{kind:"move",dx:0,dy:1*(t.shiftKey?5:1)};if(t.key==="ArrowLeft"||t.key==="a"||t.key==="A")return{kind:"move",dx:-1*(t.shiftKey?5:1),dy:0};if(t.key==="ArrowRight"||t.key==="d"||t.key==="D")return{kind:"move",dx:1*(t.shiftKey?5:1),dy:0}}function Ut(t){if(t.key==="Escape"||t.key==="m"||t.key==="M"){n.mapOpen=!1,g();return}const e=t.shiftKey?5:1;if((t.key==="ArrowUp"||t.key==="w"||t.key==="W")&&(n.mapCursor.y-=e),(t.key==="ArrowDown"||t.key==="s"||t.key==="S")&&(n.mapCursor.y+=e),(t.key==="ArrowLeft"||t.key==="a"||t.key==="A")&&(n.mapCursor.x-=e),(t.key==="ArrowRight"||t.key==="d"||t.key==="D")&&(n.mapCursor.x+=e),(t.key==="c"||t.key==="C")&&(n.destination=void 0,n.autoPath=void 0,n.log.push("Auto-walk canceled.")),t.key==="Enter"){const o={x:n.player.pos.x+n.mapCursor.x,y:n.player.pos.y+n.mapCursor.y};qt(o),n.mapOpen=!1}g()}window.addEventListener("keydown",t=>{if(n.mapOpen){t.preventDefault(),Ut(t);return}const e=zt(t);e&&(t.preventDefault(),ce(e))});ct.addEventListener("click",()=>{n.rendererMode="ascii",A(),g()});pt.addEventListener("click",()=>{n.rendererMode="canvas",A(),g()});ft.addEventListener("click",()=>{n=le(Date.now()&4294967295),A(),g()});ht.addEventListener("click",()=>{me(),g()});yt.addEventListener("click",()=>{ge(),A(),g()});mt.addEventListener("click",()=>{n.activePanel=n.activePanel==="inventory"?"none":"inventory",g()});gt.addEventListener("click",()=>{n.activePanel=n.activePanel==="shop"?"none":"shop",n.activePanel==="shop"&&$()&&F(n,n.player.pos),g()});vt.addEventListener("click",()=>{ce({kind:"toggleMap"})});function me(){var s;const t=[...n.dungeons.values()],e=[...n.shops.values()],o={version:3,worldSeed:n.worldSeed,mode:n.mode,playerId:n.player.id,entities:n.entities,items:n.items,dungeons:t,shops:e,entranceReturnPos:(s=n.dungeonStack[0])==null?void 0:s.entranceWorldPos,activePanel:n.activePanel,turnCounter:n.turnCounter,quests:n.quests};Je(o),n.log.push("Saved.")}function ge(){const t=Ze();if(!t){n.log.push("No save found.");return}const e=new x(t.worldSeed),o=new J(t.worldSeed),s=new Map;for(const u of t.dungeons)s.set(u.id,u);const i=new Map;for(const u of t.shops)i.set(u.id,u);const r=t.entities.find(u=>u.id===t.playerId);if(r&&!r.statusEffects&&(r.statusEffects=[]),!r){n.log.push("Save missing player.");return}n={worldSeed:t.worldSeed,rng:e,mode:t.mode,overworld:o,dungeons:s,dungeonStack:Vt(t,r),player:r,entities:t.entities,items:t.items,shops:i,rendererMode:n.rendererMode,useFov:n.useFov,activePanel:t.activePanel??"none",shopCategory:"all",turnCounter:t.turnCounter??0,quests:t.quests??[],log:new ie(160)},n.log.push("Loaded.")}function Vt(t,e){if(e.mapRef.kind!=="dungeon")return[];const o=t.dungeons.find(r=>r.id===e.mapRef.dungeonId);if(!o)return[];const s=t.entranceReturnPos??{x:0,y:0},i=[];for(let r=0;r<=o.depth;r++)i.push({baseId:o.baseId,depth:r,entranceWorldPos:s});return i}A();g();
