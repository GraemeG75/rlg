(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const u of r.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&i(u)}).observe(document,{childList:!0,subtree:!0});function o(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(s){if(s.ep)return;s.ep=!0;const r=o(s);fetch(s.href,r)}})();class S{constructor(e){this.state=e|0,this.state===0&&(this.state=19088743)}nextU32(){let e=this.state|0;return e^=e<<13,e^=e>>>17,e^=e<<5,this.state=e|0,e>>>0}nextFloat(){return this.nextU32()/4294967295}nextInt(e,o){const i=o-e;return i<=0?e:e+this.nextU32()%i}pickOne(e){return e[this.nextInt(0,e.length)]}}function O(t,e,o){return Math.max(e,Math.min(o,t))}function K(t,e){return{x:t.x+e.x,y:t.y+e.y}}function N(t,e){return Math.abs(t.x-e.x)+Math.abs(t.y-e.y)}function H(t){return`${t.x},${t.y}`}function ee(t){const e=t.split(",");if(e.length!==2)return;const o=Number(e[0]),i=Number(e[1]);if(!(Number.isNaN(o)||Number.isNaN(i)))return{x:o,y:i}}function F(t,e,o){let i=t|0;return i^=e*374761393|0,i^=o*668265263|0,i=i^i>>>13|0,i=Math.imul(i,1274126177)|0,i^=i>>>16,i|0}const b=64;class te{constructor(e){this.worldSeed=e,this.chunks=new Map}getTile(e,o){const i=Math.floor(e/b),s=Math.floor(o/b),r=(e%b+b)%b,u=(o%b+b)%b;return this.getOrCreateChunk(i,s).tiles[u*b+r]}isWalkable(e){return e!=="water"&&e!=="mountain"}getOrCreateChunk(e,o){const i=`${e},${o}`,s=this.chunks.get(i);if(s)return s;const r=be(this.worldSeed,e,o);return this.chunks.set(i,r),r}}function C(t,e,o){return e*o+t}function J(t){return t!=="water"&&t!=="mountain"}function ke(t,e,o){let i=e.x,s=e.y;for(;i!==o.x;)t[C(i,s,b)]="road",i+=i<o.x?1:-1;for(;s!==o.y;)t[C(i,s,b)]="road",s+=s<o.y?1:-1;t[C(i,s,b)]="road"}function be(t,e,o){const i=F(t,e,o),s=new S(i),r=new Array(b*b),u=[];for(let d=0;d<b;d++)for(let c=0;c<b;c++){const p=F(i,c,d),f=new S(p),g=f.nextFloat(),y=f.nextFloat();let m="grass";g<.22?m="water":g>.86?m="mountain":y>.78?m="forest":m="grass",r[C(c,d,b)]=m}const l=s.nextInt(0,3);for(let d=0;d<l;d++){const c=s.nextInt(3,b-3),p=s.nextInt(3,b-3),f=C(c,p,b);J(r[f])&&(r[f]="town",u.push({x:c,y:p}))}if(u.length>=2)for(const d of u){let c,p=999999;for(const f of u){if(f.x===d.x&&f.y===d.y)continue;const g=N(d,f);g<p&&(p=g,c=f)}c&&ke(r,d,c)}const a=s.nextInt(0,3);for(let d=0;d<a;d++){const c=s.nextInt(0,b),p=s.nextInt(0,b),f=C(c,p,b),g=r[f];J(g)&&g!=="town"&&(r[f]="dungeon")}return{chunkX:e,chunkY:o,tiles:r,towns:u}}function xe(t,e,o){return`dng_${t}_${e}_${o}`}function ne(t,e){return`${t}_L${e}`}function Ie(t,e,o){return F(t,e,o)}function Q(t,e,o){return`town_${t}_${e}_${o}`}function I(t,e,o){return e*o+t}function Se(t){return t==="floor"||t==="stairsUp"||t==="stairsDown"}function $e(t){return t==="wall"}function A(t,e,o){return t.tiles[I(e,o,t.width)]}function _(t,e,o){return t.visibility[I(e,o,t.width)]}function Pe(t,e,o,i){t.visibility[I(e,o,t.width)]=i}function Me(t,e,o,i,s,r){const u=new S(i),l=new Array(s*r).fill("wall"),a=new Array(s*r).fill("unseen"),d=[];function c(k,h,w,x){for(let $=h;$<h+x;$++)for(let T=k;T<k+w;T++)l[I(T,$,s)]="floor"}function p(k,h){let w=k.x,x=k.y;if(u.nextInt(0,2)===0){for(;w!==h.x;)l[I(w,x,s)]="floor",w+=w<h.x?1:-1;for(;x!==h.y;)l[I(w,x,s)]="floor",x+=x<h.y?1:-1}else{for(;x!==h.y;)l[I(w,x,s)]="floor",x+=x<h.y?1:-1;for(;w!==h.x;)l[I(w,x,s)]="floor",w+=w<h.x?1:-1}l[I(w,x,s)]="floor"}const f=14;for(let k=0;k<f;k++){const h=u.nextInt(6,13),w=u.nextInt(5,11),x=u.nextInt(1,Math.max(2,s-h-1)),$=u.nextInt(1,Math.max(2,r-w-1));let T=!1;for(const E of d)if(x<E.x+E.w+1&&x+h+1>E.x&&$<E.y+E.h+1&&$+w+1>E.y){T=!0;break}if(T)continue;c(x,$,h,w);const j={x:x+Math.floor(h/2),y:$+Math.floor(w/2)};d.push({x,y:$,w:h,h:w,center:j}),d.length>1&&p(d[d.length-2].center,j)}const g=d.length>0?d[0].center:{x:2,y:2},y=d.length>0?d[d.length-1].center:{x:s-3,y:r-3};l[I(g.x,g.y,s)]="stairsUp",l[I(y.x,y.y,s)]="stairsDown";const m=Ae(o);return{id:t,baseId:e,depth:o,theme:m,width:s,height:r,tiles:l,visibility:a,stairsUp:g,stairsDown:y}}function oe(t,e){const o=new S(e);for(let i=0;i<2e3;i++){const s=o.nextInt(1,t.width-1),r=o.nextInt(1,t.height-1);if(t.tiles[I(s,r,t.width)]==="floor")return{x:s,y:r}}return{x:t.stairsDown.x,y:t.stairsDown.y}}function Ae(t){return t<3?"ruins":t<6?"caves":"crypt"}function Re(t,e){const o=[];let i=t.x,s=t.y;const r=e.x,u=e.y,l=Math.abs(r-i),a=Math.abs(u-s),d=i<r?1:-1,c=s<u?1:-1;let p=l-a;for(;o.push({x:i,y:s}),!(i===r&&s===u);){const f=2*p;f>-a&&(p-=a,i+=d),f<l&&(p+=l,s+=c)}return o}function ie(t){for(let e=0;e<t.visibility.length;e++)t.visibility[e]==="visible"&&(t.visibility[e]="seen")}function se(t,e,o){const i=new Set,s=O(e.x-o,0,t.width-1),r=O(e.x+o,0,t.width-1),u=O(e.y-o,0,t.height-1),l=O(e.y+o,0,t.height-1),a=o*o;for(let d=u;d<=l;d++)for(let c=s;c<=r;c++){const p=c-e.x,f=d-e.y;if(p*p+f*f>a)continue;const g=Re(e,{x:c,y:d});for(let y=0;y<g.length;y++){const m=g[y];if(m.x<0||m.y<0||m.x>=t.width||m.y>=t.height)break;const k=`${m.x},${m.y}`;if(i.add(k),Pe(t,m.x,m.y,"visible"),m.x===c&&m.y===d)break;const h=A(t,m.x,m.y);if($e(h)&&!(m.x===e.x&&m.y===e.y))break}}return i}function G(t,e,o,i){for(const s of t)if(!(s.mapRef.kind!=="dungeon"||s.mapRef.dungeonId!==o)&&s.pos.x===i.x&&s.pos.y===i.y&&s.hp>0)return s}function W(t,e){const o=t.getTile(e.x,e.y);return t.isWalkable(o)}function X(t,e){if(e.x<0||e.y<0||e.x>=t.width||e.y>=t.height)return!1;const o=A(t,e.x,e.y);return Se(o)}function re(t,e,o,i,s=5e3){const r=H(t),u=H(e),l=new Set([r]),a=new Map,d=new Map;d.set(r,0);const c=new Map;c.set(r,N(t,e));let p=0;for(;l.size>0&&p<s;){p++;let f,g=Number.POSITIVE_INFINITY;for(const k of l){const h=c.get(k)??Number.POSITIVE_INFINITY;h<g&&(g=h,f=k)}if(!f)break;if(f===u)return Te(a,f);l.delete(f);const y=ee(f);if(!y)break;const m=[{x:y.x+1,y:y.y},{x:y.x-1,y:y.y},{x:y.x,y:y.y+1},{x:y.x,y:y.y-1}];for(const k of m){if(!o(k))continue;const h=H(k);if(i(k)&&h!==u)continue;const w=(d.get(f)??Number.POSITIVE_INFINITY)+1,x=d.get(h)??Number.POSITIVE_INFINITY;w<x&&(a.set(h,f),d.set(h,w),c.set(h,w+N(k,e)),l.add(h))}}}function Te(t,e){const o=[e];for(;t.has(e);)e=t.get(e),o.push(e);o.reverse();const i=[];for(const s of o){const r=ee(s);r&&i.push(r)}return i}function Ee(t,e,o,i){const s=re(t.pos,e.pos,r=>X(o,r),r=>!!G(i,"dungeon",o.id,r));if(!(!s||s.length<2))return s[1]}function De(t,e,o){const i=Math.floor(e/2),s=Math.floor(o/2),r=t.player.pos.x,u=t.player.pos.y;let l="";for(let a=-s;a<=s;a++){for(let d=-i;d<=i;d++){const c=r+d,p=u+a;if(d===0&&a===0){l+="@";continue}const f=Ce(t,c,p);if(f){l+=f;continue}const g=_e(t,c,p);if(g){l+=g;continue}if(t.mode==="overworld"){const y=t.overworld.getTile(c,p);l+=qe(y)}else{const y=t.dungeon;if(!y){l+=" ";continue}if(c<0||p<0||c>=y.width||p>=y.height){l+=" ";continue}if(t.useFov&&_(y,c,p)==="unseen"){l+=" ";continue}l+=Be(A(y,c,p))}}l+=`
`}return l}function Ce(t,e,o){for(const i of t.entities)if(i.kind==="monster"&&!(i.hp<=0)){if(t.mode==="overworld"){if(i.mapRef.kind!=="overworld")continue}else if(i.mapRef.kind!=="dungeon"||!t.dungeon||i.mapRef.dungeonId!==t.dungeon.id||t.useFov&&_(t.dungeon,e,o)!=="visible")continue;if(i.pos.x===e&&i.pos.y===o)return i.glyph}}function _e(t,e,o){for(const i of t.items)if(!(!i.mapRef||!i.pos)){if(t.mode==="overworld"){if(i.mapRef.kind!=="overworld")continue}else if(i.mapRef.kind!=="dungeon"||!t.dungeon||i.mapRef.dungeonId!==t.dungeon.id||t.useFov&&_(t.dungeon,e,o)!=="visible")continue;if(i.pos.x===e&&i.pos.y===o)return Fe(i.kind)}}function Fe(t){switch(t){case"potion":return"!";case"weapon":return")";case"armor":return"]";default:return"?"}}function qe(t){switch(t){case"water":return"~";case"grass":return".";case"forest":return"♣";case"mountain":return"^";case"dungeon":return"D";case"town":return"T";case"road":return"=";default:return"?"}}function Be(t){switch(t){case"wall":return"#";case"floor":return".";case"stairsUp":return"<";case"stairsDown":return">";default:return"?"}}class Oe{constructor(e){this.tileSize=e,this.sprites=new Map,this.buildAll()}get(e){const o=this.sprites.get(e);if(!o)throw new Error(`Missing sprite: ${e}`);return o}buildAll(){this.sprites.set("ow_water",this.make(e=>this.fill(e,"#0b355a","#0f4d7f"))),this.sprites.set("ow_grass",this.make(e=>this.fill(e,"#11402a","#1a5b3c"))),this.sprites.set("ow_forest",this.make(e=>this.patternForest(e))),this.sprites.set("ow_mountain",this.make(e=>this.patternMountain(e))),this.sprites.set("ow_road",this.make(e=>this.patternRoad(e))),this.sprites.set("ow_town",this.make(e=>this.patternTown(e))),this.sprites.set("ow_dungeon",this.make(e=>this.patternDungeonEntrance(e))),this.sprites.set("dg_wall_ruins",this.make(e=>this.patternStone(e,"#202a36","#2d3a4b"))),this.sprites.set("dg_floor_ruins",this.make(e=>this.patternFloor(e,"#0b1320","#0f1b2d"))),this.sprites.set("dg_stairs_ruins",this.make(e=>this.patternStairs(e,"#15243a","#cfe3ff"))),this.sprites.set("dg_wall_caves",this.make(e=>this.patternStone(e,"#1f2a20","#2c3a2e"))),this.sprites.set("dg_floor_caves",this.make(e=>this.patternFloor(e,"#0a130c","#122015"))),this.sprites.set("dg_stairs_caves",this.make(e=>this.patternStairs(e,"#17301a","#cfe3ff"))),this.sprites.set("dg_wall_crypt",this.make(e=>this.patternStone(e,"#2a1a2f","#3b2442"))),this.sprites.set("dg_floor_crypt",this.make(e=>this.patternFloor(e,"#120914","#1b0f1f"))),this.sprites.set("dg_stairs_crypt",this.make(e=>this.patternStairs(e,"#2c1231","#e6d7ff"))),this.sprites.set("ent_player",this.make(e=>this.glyph(e,"@","#ffffff"))),this.sprites.set("ent_slime",this.make(e=>this.glyph(e,"s","#7cff9e"))),this.sprites.set("ent_goblin",this.make(e=>this.glyph(e,"g","#7cff9e"))),this.sprites.set("ent_orc",this.make(e=>this.glyph(e,"O","#7cff9e"))),this.sprites.set("it_potion",this.make(e=>this.glyph(e,"!","#ffd36b"))),this.sprites.set("it_weapon",this.make(e=>this.glyph(e,")","#ffd36b"))),this.sprites.set("it_armor",this.make(e=>this.glyph(e,"]","#ffd36b"))),this.sprites.set("ui_path",this.make(e=>this.glyph(e,"•","#93a7c8"))),this.sprites.set("ui_destination",this.make(e=>this.glyph(e,"X","#ffffff")))}make(e){const o=document.createElement("canvas");o.width=this.tileSize,o.height=this.tileSize;const i=o.getContext("2d");if(!i)throw new Error("Canvas not available.");return i.imageSmoothingEnabled=!1,e(i),o}fill(e,o,i){e.fillStyle=o,e.fillRect(0,0,this.tileSize,this.tileSize),e.fillStyle=i;for(let s=0;s<10;s++){const r=s*7%this.tileSize,u=s*11%this.tileSize;e.fillRect(r,u,1,1)}}patternForest(e){this.fill(e,"#0e2a1b","#184a2f"),e.fillStyle="#1e6a45",e.fillRect(4,4,2,6),e.fillRect(10,3,2,7),e.fillStyle="#0b1320",e.fillRect(5,10,1,2),e.fillRect(11,10,1,2)}patternMountain(e){this.fill(e,"#3a3f46","#555b63"),e.fillStyle="#9aa1ab",e.beginPath(),e.moveTo(2,13),e.lineTo(7,4),e.lineTo(12,13),e.closePath(),e.fill()}patternRoad(e){this.fill(e,"#253041","#2f3f57"),e.fillStyle="#93a7c8";for(let o=2;o<this.tileSize-2;o+=3)e.fillRect(o,8,1,1)}patternTown(e){this.fill(e,"#2b3b58","#334a70"),e.fillStyle="#cfe3ff",e.fillRect(5,8,6,5),e.fillRect(6,6,4,2),e.fillStyle="#0b1320",e.fillRect(7,10,2,3)}patternDungeonEntrance(e){this.fill(e,"#553a8a","#6a4fb0"),e.fillStyle="#e6d7ff",e.fillRect(5,6,6,8),e.fillStyle="#120914",e.fillRect(6,8,4,6)}patternStone(e,o,i){this.fill(e,o,i),e.fillStyle=i,e.fillRect(2,3,5,2),e.fillRect(8,9,6,2)}patternFloor(e,o,i){this.fill(e,o,i),e.fillStyle=i,e.fillRect(4,4,1,1),e.fillRect(11,11,1,1)}patternStairs(e,o,i){this.fill(e,o,"#1a2433"),this.glyph(e,">",i)}glyph(e,o,i){e.fillStyle="rgba(0,0,0,0)",e.fillRect(0,0,this.tileSize,this.tileSize),e.fillStyle="rgba(0,0,0,0)",e.fillRect(0,0,this.tileSize,this.tileSize),e.fillStyle="rgba(0,0,0,0)",e.fillRect(0,0,this.tileSize,this.tileSize),e.fillStyle="rgba(0,0,0,0)",e.fillRect(0,0,this.tileSize,this.tileSize),e.fillStyle=i,e.font="12px monospace",e.textBaseline="top",e.fillText(o,5,2)}}class Le{constructor(e){this.canvas=e;const o=e.getContext("2d");if(!o)throw new Error("Canvas 2D context not available.");this.ctx=o,this.ctx.font="12px monospace",this.atlas=new Oe(16)}render(e,o,i){const r=Math.floor(o/2),u=Math.floor(i/2),l=e.player.pos.x,a=e.player.pos.y;this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);for(let d=-u;d<=u;d++)for(let c=-r;c<=r;c++){const p=l+c,f=a+d,g=(c+r)*16,y=(d+u)*16;if(e.mode==="overworld"){const h=e.overworld.getTile(p,f);this.drawOverworldTile(h,g,y,16)}else{const h=e.dungeon;if(!h||p<0||f<0||p>=h.width||f>=h.height)continue;if(e.useFov){const w=_(h,p,f);if(w==="unseen")continue;w==="seen"?this.drawDungeonTile(h.theme,A(h,p,f),g,y,16,.35):this.drawDungeonTile(h.theme,A(h,p,f),g,y,16,1)}else this.drawDungeonTile(h.theme,A(h,p,f),g,y,16,1)}const m=this.findItemAt(e,p,f);m&&(this.ctx.fillStyle="#ffd36b",this.ctx.fillText(Ne(m.kind),g+5,y+12));const k=this.findMonsterAt(e,p,f);k&&(this.ctx.fillStyle="#7CFF9E",this.ctx.fillText(k.glyph,g+5,y+12)),c===0&&d===0&&(this.ctx.fillStyle="#FFFFFF",this.ctx.fillText("@",g+5,y+12))}}findMonsterAt(e,o,i){for(const s of e.entities)if(s.kind==="monster"&&!(s.hp<=0))if(e.mode==="overworld"){if(s.mapRef.kind!=="overworld")continue;if(s.pos.x===o&&s.pos.y===i)return s}else{if(!e.dungeon||s.mapRef.kind!=="dungeon"||s.mapRef.dungeonId!==e.dungeon.id||e.useFov&&_(e.dungeon,o,i)!=="visible")continue;if(s.pos.x===o&&s.pos.y===i)return s}}findItemAt(e,o,i){for(const s of e.items)if(!(!s.mapRef||!s.pos)){if(e.mode==="overworld"){if(s.mapRef.kind!=="overworld")continue}else if(!e.dungeon||s.mapRef.kind!=="dungeon"||s.mapRef.dungeonId!==e.dungeon.id||e.useFov&&_(e.dungeon,o,i)!=="visible")continue;if(s.pos.x===o&&s.pos.y===i)return s}}drawOverworldTile(e,o,i,s){const r=e==="water"?"ow_water":e==="grass"?"ow_grass":e==="forest"?"ow_forest":e==="mountain"?"ow_mountain":e==="road"?"ow_road":e==="town"?"ow_town":e==="dungeon"?"ow_dungeon":"ow_grass",u=this.atlas.get(r);this.ctx.drawImage(u,o,i,s,s)}drawDungeonTile(e,o,i,s,r,u){this.ctx.globalAlpha=u;const l=We(e);switch(o){case"wall":this.ctx.fillStyle=l.wall;break;case"floor":this.ctx.fillStyle=l.floor;break;case"stairsUp":this.ctx.fillStyle=l.stairs;break;case"stairsDown":this.ctx.fillStyle=l.stairs;break;default:this.ctx.fillStyle="#222";break}this.ctx.fillRect(i,s,r,r),this.ctx.globalAlpha=1,o==="stairsUp"&&(this.ctx.fillStyle=l.glyph,this.ctx.fillText("<",i+5,s+12)),o==="stairsDown"&&(this.ctx.fillStyle=l.glyph,this.ctx.fillText(">",i+5,s+12))}}function Ne(t){switch(t){case"potion":return"!";case"weapon":return")";case"armor":return"]";default:return"?"}}function We(t){switch(t){case"ruins":return{wall:"#202a36",floor:"#0b1320",stairs:"#15243a",glyph:"#cfe3ff"};case"caves":return{wall:"#1f2a20",floor:"#0a130c",stairs:"#17301a",glyph:"#cfe3ff"};case"crypt":return{wall:"#2a1a2f",floor:"#120914",stairs:"#2c1231",glyph:"#e6d7ff"};default:return{wall:"#1b2430",floor:"#0b1320",stairs:"#122033",glyph:"#cfe3ff"}}}class ae{constructor(e){this.max=e,this.items=[]}push(e){for(this.items.unshift({text:e,t:Date.now()});this.items.length>this.max;)this.items.pop()}all(){return[...this.items]}}const le="web-roguelike-starter-save-v3";function He(t){const e=JSON.stringify(t);localStorage.setItem(le,e)}function Ye(){const t=localStorage.getItem(le);if(!t)return;const o=JSON.parse(t);if(!(!o||o.version!==3))return o}function ze(t){return t.mode==="inventory"?Ue(t.player,t.items):t.mode==="shop"?Ve(t.player,t.items,t.activeShop,t.canShop,t.shopCategory):t.mode==="quest"?renderQuestLog(t.quests,t.activeTownId):'<div class="small muted">Panels: <b>I</b> inventory • <b>B</b> shop (in town) • <b>Q</b> quests (in town)</div>'}function Ue(t,e){const o=t.inventory.map(a=>e.find(d=>d.id===a)).filter(a=>!!a),i=t.equipment.weaponItemId,s=t.equipment.armorItemId,r=i?e.find(a=>a.id===i):void 0,u=s?e.find(a=>a.id===s):void 0,l=[];if(l.push('<div class="panelTitle"><b>Inventory</b><span class="tag">I to close</span></div>'),l.push(`<div class="small">Gold: <b>${t.gold}</b> • Level: <b>${t.level}</b> • XP: <b>${t.xp}</b></div>`),l.push(`<div class="small">Weapon: ${r?`<b>${M(r.name)}</b>`:'<span class="muted">none</span>'}</div>`),l.push(`<div class="small">Armor: ${u?`<b>${M(u.name)}</b>`:'<span class="muted">none</span>'}</div>`),l.push('<div class="sep"></div>'),o.length===0)return l.push('<div class="small muted">Empty.</div>'),l.join("");l.push('<div class="grid">');for(const a of o.slice(0,60)){const d=a.kind==="potion"?`(+${a.healAmount??0} HP)`:a.kind==="weapon"?`(+${a.attackBonus??0} Atk)`:a.kind==="armor"?`(+${a.defenseBonus??0} Def)`:"",c=[];if(a.kind==="potion"&&c.push(`<button class="btnTiny" data-act="use" data-item="${a.id}">Use</button>`),a.kind==="weapon"){const p=t.equipment.weaponItemId,f=p?e.find(k=>k.id===p):void 0,g=(f==null?void 0:f.attackBonus)??0,m=(a.attackBonus??0)-g;c.push(`<button class="btnTiny" data-act="equipWeapon" data-item="${a.id}">Equip ${m===0?"":m>0?"(+"+m+")":"("+m+")"}</button>`)}if(a.kind==="armor"){const p=t.equipment.armorItemId,f=p?e.find(k=>k.id===p):void 0,g=(f==null?void 0:f.defenseBonus)??0,m=(a.defenseBonus??0)-g;c.push(`<button class="btnTiny" data-act="equipArmor" data-item="${a.id}">Equip ${m===0?"":m>0?"(+"+m+")":"("+m+")"}</button>`)}c.push(`<button class="btnTiny" data-act="drop" data-item="${a.id}">Drop</button>`),l.push(`<div class="small">• ${M(a.name)} <span class="muted">${M(d)}</span></div>`),l.push(`<div class="row" style="justify-content:flex-end;">${c.join("")}</div>`)}return l.push("</div>"),l.join("")}function Ve(t,e,o,i,s){const r=[];if(r.push('<div class="panelTitle"><b>Town Shop</b><span class="tag">B to close</span></div>'),!i)return r.push('<div class="small muted">You need to be standing on a town tile (T) to shop.</div>'),r.join("");if(!o)return r.push('<div class="small muted">No shop found for this town.</div>'),r.join("");r.push(`<div class="small">Gold: <b>${t.gold}</b></div>`),r.push('<div class="row" style="margin-top:6px;"><button class="btnTiny" data-act="shopCat" data-cat="all">All</button><button class="btnTiny" data-act="shopCat" data-cat="potion">Potions</button><button class="btnTiny" data-act="shopCat" data-cat="weapon">Weapons</button><button class="btnTiny" data-act="shopCat" data-cat="armor">Armor</button></div>'),r.push('<div class="sep"></div>'),r.push('<div class="small muted">Buy</div>'),r.push('<div class="grid">');for(const l of o.stockItemIds.slice(0,40)){const a=e.find(p=>p.id===l);if(!a||s!=="all"&&a.kind!==s)continue;const d=a.value,c=a.kind==="potion"?`(+${a.healAmount??0} HP)`:a.kind==="weapon"?`(+${a.attackBonus??0} Atk)`:a.kind==="armor"?`(+${a.defenseBonus??0} Def)`:"";r.push(`<div class="small">• ${M(a.name)} <span class="muted">${M(c)}</span> <span class="muted">(${d}g)</span></div>`),r.push(`<div class="row" style="justify-content:flex-end;"><button class="btnTiny" data-act="buy" data-item="${a.id}">Buy</button></div>`)}r.push("</div>"),r.push('<div class="sep"></div>'),r.push('<div class="small muted">Sell (from inventory)</div>');const u=t.inventory.map(l=>e.find(a=>a.id===l)).filter(l=>!!l);if(u.length===0)return r.push('<div class="small muted">Nothing to sell.</div>'),r.join("");r.push('<div class="grid">');for(const l of u.slice(0,30)){const a=Math.max(1,Math.floor(l.value*.5));r.push(`<div class="small">• ${M(l.name)} <span class="muted">(${a}g)</span></div>`),r.push(`<div class="row" style="justify-content:flex-end;"><button class="btnTiny" data-act="sell" data-item="${l.id}">Sell</button></div>`)}return r.push("</div>"),r.join("")}function M(t){return t.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")}function Qe(t,e,o){const i=Math.floor(e/2),s=Math.floor(o/2),r=t.player.pos.x,u=t.player.pos.y,l=new Set;if(t.autoPath)for(const d of t.autoPath)l.add(`${d.x},${d.y}`);let a="";for(let d=-s;d<=s;d++){for(let c=-i;c<=i;c++){const p=r+c,f=u+d;if(c===0&&d===0){a+="@";continue}if(t.destination&&t.destination.x===p&&t.destination.y===f){a+="X";continue}const g=`${p},${f}`;if(l.has(g)){a+="*";continue}const y=t.overworld.getTile(p,f);a+=Ge(y)}a+=`
`}return a}function Ge(t){switch(t){case"water":return"~";case"grass":return".";case"forest":return"♣";case"mountain":return"^";case"dungeon":return"D";case"town":return"T";case"road":return"=";default:return"?"}}const Xe=61,je=33,D=document.getElementById("ascii"),L=document.getElementById("canvasWrap"),Ke=document.getElementById("modePill"),Je=document.getElementById("renderPill"),Ze=document.getElementById("stats"),ue=document.getElementById("panel"),et=document.getElementById("log"),tt=document.getElementById("btnAscii"),nt=document.getElementById("btnCanvas"),ot=document.getElementById("btnNewSeed"),it=document.getElementById("btnSave"),st=document.getElementById("btnLoad"),rt=document.getElementById("btnInv"),at=document.getElementById("btnShop"),lt=document.getElementById("btnMap"),Y=document.getElementById("gameCanvas"),ut=new Le(Y);function de(t){const e=new S(t),o=new te(t),i={id:"player",kind:"player",name:"You",glyph:"@",pos:dt(o,e),mapRef:{kind:"overworld"},hp:20,maxHp:20,baseAttack:2,baseDefense:0,level:1,xp:0,gold:20,inventory:[],equipment:{},statusEffects:[]},s={worldSeed:t,rng:e,mode:"overworld",overworld:o,dungeons:new Map,dungeonStack:[],player:i,entities:[i],items:[],shops:new Map,rendererMode:"ascii",useFov:!0,activePanel:"none",shopCategory:"all",turnCounter:0,quests:[],mapOpen:!1,mapCursor:{x:0,y:0},destination:void 0,autoPath:void 0,log:new ae(160)};return s.log.push("Welcome. Find a town (T) to shop or a dungeon (D) to descend."),s.log.push("I inventory • B shop (town) • Q quests (town) • G pick up items in dungeons."),s.log.push("P save • O load • R renderer • F FOV"),s}function dt(t,e){for(let o=0;o<4e3;o++){const i=e.nextInt(-200,200),s=e.nextInt(-200,200);if(W(t,{x:i,y:s}))return{x:i,y:s}}return{x:0,y:0}}let n=de(Date.now()&4294967295);function q(t){if(t.player.mapRef.kind==="dungeon")return t.dungeons.get(t.player.mapRef.dungeonId)}function ce(t,e,o,i){const s=ne(e,o),r=t.dungeons.get(s);if(r)return r;const l=Ie(t.worldSeed,i.x,i.y)^o*2654435769|0,a=Me(s,e,o,l,80,50);return ct(t,a,l),ft(t,a,l),t.dungeons.set(s,a),a}function ct(t,e,o){const i=5+Math.min(12,e.depth*2),s=new S(o^48879);for(let r=0;r<i;r++){const u=oe(e,o+1e3+r*17),l=s.nextInt(0,100),a=pt(e.depth,l,t.rng,e.id,r,u);t.entities.push(a)}}function pt(t,e,o,i,s,r){return e<35?{id:`m_${i}_${s}`,kind:"monster",name:"Slime",glyph:"s",pos:r,mapRef:{kind:"dungeon",dungeonId:i},hp:4+t,maxHp:4+t,baseAttack:1+Math.floor(t/2),baseDefense:0,level:1,xp:0,gold:0,inventory:[],equipment:{}}:e<75?{id:`m_${i}_${s}`,kind:"monster",name:"Goblin",glyph:"g",pos:r,mapRef:{kind:"dungeon",dungeonId:i},hp:6+t*2,maxHp:6+t*2,baseAttack:2+t,baseDefense:Math.floor(t/3),level:1,xp:0,gold:0,inventory:[],equipment:{}}:{id:`m_${i}_${s}`,kind:"monster",name:"Orc",glyph:"O",pos:r,mapRef:{kind:"dungeon",dungeonId:i},hp:10+t*3,maxHp:10+t*3,baseAttack:3+t,baseDefense:1+Math.floor(t/2),level:1,xp:0,gold:0,inventory:[],equipment:{},statusEffects:[]}}function ft(t,e,o){const i=new S(o^335637),s=8;for(let r=0;r<s;r++){const u=oe(e,o+5e3+r*31),l=i.nextInt(0,100);let a;l<55?a={id:`it_${e.id}_${r}`,kind:"potion",name:e.depth>=4?"Greater Healing Potion":"Healing Potion",healAmount:8+e.depth*2,mapRef:{kind:"dungeon",dungeonId:e.id},pos:u,value:10+e.depth*2}:l<85?a={id:`it_${e.id}_${r}`,kind:"weapon",name:e.depth>=4?"Iron Sword":"Rusty Sword",attackBonus:2+e.depth,mapRef:{kind:"dungeon",dungeonId:e.id},pos:u,value:18+e.depth*3}:a={id:`it_${e.id}_${r}`,kind:"armor",name:e.depth>=4?"Chain Vest":"Leather Armor",defenseBonus:1+Math.floor(e.depth/2),mapRef:{kind:"dungeon",dungeonId:e.id},pos:u,value:18+e.depth*3},t.items.push(a)}}function pe(){if(!(n.mode!=="overworld"||n.overworld.getTile(n.player.pos.x,n.player.pos.y)!=="town"))return Q(n.worldSeed,n.player.pos.x,n.player.pos.y)}function z(t,e){const o=Q(t.worldSeed,e.x,e.y);if(t.quests.some(u=>u.townId===o))return;const i=F(t.worldSeed,e.x,e.y)^659918,s=new S(i),r=1+s.nextInt(0,2);for(let u=0;u<r;u++){const l=1+s.nextInt(0,4),a=6+s.nextInt(0,8),d=20+l*10+s.nextInt(0,10),c=18+l*8+s.nextInt(0,10),p={id:`q_${o}_${u}`,townId:o,kind:"killMonsters",description:`Clear threats: defeat ${a} monsters (depth ≥ ${l})`,targetCount:a,currentCount:0,minDungeonDepth:l,rewardGold:d,rewardXp:c,completed:!1,turnedIn:!1};t.quests.push(p)}}function ht(t,e){for(const o of t.quests)o.kind==="killMonsters"&&(o.completed||o.turnedIn||e<o.minDungeonDepth||(o.currentCount+=1,o.currentCount>=o.targetCount&&(o.currentCount=o.targetCount,o.completed=!0,t.log.push(`Quest complete: ${o.description}. Return to town to turn in (Q).`))))}function yt(t){const e=t.player.statusEffects??[];if(e.length!==0){for(const o of e)o.kind==="poison"&&(t.player.hp-=o.potency,t.log.push(`Poison deals ${o.potency} damage. (${Math.max(0,t.player.hp)}/${t.player.maxHp})`)),o.remainingTurns-=1;t.player.statusEffects=e.filter(o=>o.remainingTurns>0),t.player.hp<=0&&t.log.push("You succumb to your wounds.")}}function mt(t){if(t.name!=="Slime"||n.rng.nextInt(0,100)>=20)return;const o=n.player.statusEffects??[],i=o.find(s=>s.kind==="poison");i?(i.remainingTurns=Math.max(i.remainingTurns,5),i.potency=Math.max(i.potency,1)):o.push({kind:"poison",remainingTurns:5,potency:1}),n.player.statusEffects=o,n.log.push("You are poisoned!")}function U(t,e){if(!(t.turnCounter%80===0))return;const s=F(t.worldSeed,e.townWorldPos.x,e.townWorldPos.y)^Math.floor(t.turnCounter/80)*2654435769,r=new S(s),u=new Set(e.stockItemIds);t.items=t.items.filter(a=>!u.has(a.id));const l=[];for(let a=0;a<10;a++){const d=r.nextInt(0,100),c=`shop_${e.id}_${Math.floor(t.turnCounter/80)}_${a}`;let p;d<45?p={id:c,kind:"potion",name:"Healing Potion",healAmount:10,value:14}:d<75?p={id:c,kind:"weapon",name:"Steel Dagger",attackBonus:3,value:30}:p={id:c,kind:"armor",name:"Padded Vest",defenseBonus:2,value:28},t.items.push(p),l.push(c)}e.stockItemIds=l,t.log.push("The shop has new stock.")}function B(t,e){const o=Q(t.worldSeed,e.x,e.y),i=t.shops.get(o);if(i)return i;const s=[],r=F(t.worldSeed,e.x,e.y),u=new S(r^12648430);for(let a=0;a<10;a++){const d=u.nextInt(0,100),c=`shop_${o}_${a}`;let p;d<45?p={id:c,kind:"potion",name:"Healing Potion",healAmount:10,value:14}:d<75?p={id:c,kind:"weapon",name:"Steel Dagger",attackBonus:3,value:30}:p={id:c,kind:"armor",name:"Padded Vest",defenseBonus:2,value:28},t.items.push(p),s.push(c)}const l={id:o,townWorldPos:{x:e.x,y:e.y},stockItemIds:s};return t.shops.set(o,l),l}function P(){return n.mode==="overworld"&&n.overworld.getTile(n.player.pos.x,n.player.pos.y)==="town"}function gt(){return n.mode==="overworld"&&n.overworld.getTile(n.player.pos.x,n.player.pos.y)==="dungeon"}function vt(t){t.entities=t.entities.filter(e=>e.hp>0||e.kind==="player")}function fe(t){if(t.kind==="toggleRenderer"){n.rendererMode=n.rendererMode==="ascii"?"canvas":"ascii",R(),v();return}if(t.kind==="toggleFov"){n.useFov=!n.useFov,n.log.push(n.useFov?"FOV enabled.":"FOV disabled."),v();return}if(t.kind==="toggleInventory"){n.activePanel=n.activePanel==="inventory"?"none":"inventory",v();return}if(t.kind==="toggleShop"){if(n.activePanel=n.activePanel==="shop"?"none":"shop",n.activePanel==="shop"&&P()){B(n,n.player.pos),z(n,n.player.pos);const o=B(n,n.player.pos);U(n,o)}v();return}if(t.kind==="toggleMap"){if(n.mode!=="overworld"){n.log.push("Map is only available on the overworld."),v();return}n.mapOpen=!n.mapOpen,n.activePanel="none",n.mapCursor={x:0,y:0},n.mapOpen&&n.log.push("Map open: move cursor with WASD/Arrows, Enter to set destination, Esc/M to close, C to cancel auto-walk."),v();return}if(t.kind==="cancelAuto"){n.destination=void 0,n.autoPath=void 0,n.log.push("Auto-walk canceled."),v();return}if(t.kind==="toggleQuest"){if(n.activePanel=n.activePanel==="quest"?"none":"quest",n.activePanel==="quest"&&P()){z(n,n.player.pos);const o=B(n,n.player.pos);U(n,o)}v();return}if(t.kind==="save"){ve(),v();return}if(t.kind==="load"){we(),R(),v();return}if(t.kind==="help"){n.log.push("Keys: WASD/Arrows move • Shift+Move run (overworld) • M map • Enter use • I inventory • B shop (town) • Q quests (town) • G pick up • R renderer • F FOV • P save • O load."),v();return}if(n.turnCounter+=1,yt(n),n.player.hp<=0){v();return}if(!wt(t)){v();return}xt(),vt(n),n.player.hp<=0&&n.log.push("You died. Press New Seed to restart."),v()}function wt(t){if(n.player.hp<=0)return!1;if(n.mode==="overworld"&&n.autoPath&&n.autoPath.length>=2&&(t.kind==="move"||t.kind==="wait")){const e=n.autoPath[1];if(!W(n.overworld,e))return n.log.push("Auto-walk blocked."),n.destination=void 0,n.autoPath=void 0,!1;n.player.pos={x:e.x,y:e.y},n.autoPath=n.autoPath.slice(1),n.destination&&n.player.pos.x===n.destination.x&&n.player.pos.y===n.destination.y&&(n.log.push("Arrived at destination."),n.destination=void 0,n.autoPath=void 0);const o=n.overworld.getTile(n.player.pos.x,n.player.pos.y);return o==="dungeon"&&n.log.push("Dungeon entrance found. Press Enter to enter."),o==="town"&&n.log.push("Town found. Press Enter then B/Q."),!0}if(t.kind==="wait")return n.log.push("You wait."),!0;if(t.kind==="pickup")return kt();if(t.kind==="use"){if(n.mode==="overworld")return gt()?(It(n.player.pos),!0):P()?(n.log.push("You're in town. Press B to open the shop."),!0):(n.log.push("Nothing to use here."),!1);{const e=q(n);if(!e)return!1;const o=A(e,n.player.pos.x,n.player.pos.y);return o==="stairsUp"?($t(),!0):o==="stairsDown"?(St(),!0):(n.log.push("Nothing to use here."),!1)}}return t.kind==="move"?bt(t.dx,t.dy):!1}function kt(){const t=q(n);if(n.mode!=="dungeon"||!t)return n.log.push("You can only pick up items inside dungeons (for now)."),!1;for(const e of n.items)if(!(!e.mapRef||!e.pos)&&e.mapRef.kind==="dungeon"&&e.mapRef.dungeonId===t.id&&e.pos.x===n.player.pos.x&&e.pos.y===n.player.pos.y)return e.mapRef=void 0,e.pos=void 0,n.player.inventory.push(e.id),n.log.push(`Picked up: ${e.name}.`),!0;return n.log.push("Nothing to pick up."),!1}function bt(t,e){const o=K(n.player.pos,{x:t,y:e});if(n.mode==="dungeon"){const l=q(n);if(!l)return!1;const a=G(n.entities,"dungeon",l.id,o);return a&&a.kind==="monster"?(ge(n.player,a),!0):X(l,o)?(n.player.pos=o,!0):!1}const i=Math.max(Math.abs(t),Math.abs(e)),s=t===0?0:t>0?1:-1,r=e===0?0:e>0?1:-1;let u=!1;for(let l=0;l<i;l++){const a=K(n.player.pos,{x:s,y:r});if(!W(n.overworld,a))break;n.player.pos=a,u=!0,n.destination=void 0,n.autoPath=void 0;const d=n.overworld.getTile(a.x,a.y);d==="dungeon"&&n.log.push("Dungeon entrance found. Press Enter to enter."),d==="town"&&n.log.push("Town found. Press Enter then B/Q.")}return u}function he(t){const e=t.equipment.weaponItemId;if(!e)return 0;const o=n.items.find(i=>i.id===e);return(o==null?void 0:o.attackBonus)??0}function ye(t){const e=t.equipment.armorItemId;if(!e)return 0;const o=n.items.find(i=>i.id===e);return(o==null?void 0:o.defenseBonus)??0}function me(t){for(n.player.xp+=t;n.player.xp>=V(n.player.level);)n.player.xp-=V(n.player.level),n.player.level+=1,n.player.maxHp+=5,n.player.hp=n.player.maxHp,n.player.baseAttack+=1,n.player.level%2===0&&(n.player.baseDefense+=1),n.log.push(`*** Level up! You are now level ${n.player.level}. ***`)}function V(t){return 25+(t-1)*12}function ge(t,e){var l;const o=t.baseAttack+he(t),i=e.baseDefense+ye(e),s=n.rng.nextInt(0,5),r=o+s,u=Math.max(1,r-i);if(e.hp-=u,n.log.push(`${t.name} hits ${e.name} for ${u}. (${Math.max(0,e.hp)}/${e.maxHp})`),e.hp<=0&&(n.log.push(`${e.name} dies.`),t.kind==="player")){const a=6+(e.baseAttack+e.baseDefense),d=2+n.rng.nextInt(0,4);n.player.gold+=d,n.log.push(`You gain ${a} XP and loot ${d} gold.`),me(a);const c=((l=n.dungeonStack[n.dungeonStack.length-1])==null?void 0:l.depth)??0;ht(n,c)}}function xt(){if(n.mode!=="dungeon")return;const t=q(n);if(!t)return;let e;n.useFov&&(ie(t),e=se(t,n.player.pos,10));for(const o of n.entities){if(o.kind!=="monster"||o.hp<=0||o.mapRef.kind!=="dungeon"||o.mapRef.dungeonId!==t.id)continue;const i=N(o.pos,n.player.pos);if(i<=1){const r=n.player.hp;ge(o,n.player),n.player.hp<r&&n.player.hp>0&&mt(o);continue}const s=!n.useFov||(e?e.has(`${o.pos.x},${o.pos.y}`):!0);if(i<=12&&s){const r=Ee(o,n.player,t,n.entities);if(!r||G(n.entities,"dungeon",t.id,r))continue;X(t,r)&&(o.pos=r)}}}function It(t){const e=xe(n.worldSeed,t.x,t.y),o=0,i=ce(n,e,o,t);n.dungeonStack=[{baseId:e,depth:o,entranceWorldPos:{x:t.x,y:t.y}}],n.mode="dungeon",n.player.mapRef={kind:"dungeon",dungeonId:i.id},n.player.pos={x:i.stairsUp.x,y:i.stairsUp.y},n.log.push("You enter the dungeon.")}function St(){const t=n.dungeonStack[n.dungeonStack.length-1];if(!t)return;const e=t.depth+1,o=ce(n,t.baseId,e,t.entranceWorldPos);n.dungeonStack.push({baseId:t.baseId,depth:e,entranceWorldPos:t.entranceWorldPos}),n.player.mapRef={kind:"dungeon",dungeonId:o.id},n.player.pos={x:o.stairsUp.x,y:o.stairsUp.y},n.log.push(`You descend to depth ${e}. Theme: ${o.theme}.`)}function $t(){if(n.dungeonStack.length<=1){const i=n.dungeonStack[0];if(!i)return;n.mode="overworld",n.player.mapRef={kind:"overworld"},n.player.pos={x:i.entranceWorldPos.x,y:i.entranceWorldPos.y},n.dungeonStack=[],n.log.push("You return to the overworld.");return}n.dungeonStack.pop();const t=n.dungeonStack[n.dungeonStack.length-1],e=ne(t.baseId,t.depth),o=n.dungeons.get(e);o&&(n.player.mapRef={kind:"dungeon",dungeonId:e},n.player.pos={x:o.stairsDown.x,y:o.stairsDown.y},n.log.push(`You ascend to depth ${t.depth}.`))}function Pt(t){if(n.mode!=="overworld")return;const e=re(n.player.pos,t,o=>W(n.overworld,o),o=>!1,2e4);if(!e||e.length<2){n.log.push("No path found to destination."),n.destination=void 0,n.autoPath=void 0;return}n.destination=t,n.autoPath=e,n.log.push(`Auto-walk set: ${t.x}, ${t.y}. Press any move/space to advance, or C to cancel.`)}function R(){const t=n.rendererMode==="ascii";D.style.display=t?"block":"none",L.style.display=t?"none":"block"}function v(){var r;const t=q(n);Ke.textContent=n.mode==="overworld"?"Mode: overworld":`Mode: dungeon (depth ${((r=n.dungeonStack[n.dungeonStack.length-1])==null?void 0:r.depth)??0} • ${(t==null?void 0:t.theme)??"?"})`,Je.textContent=`Renderer: ${n.rendererMode} • FOV: ${n.useFov?"on":"off"}`,n.mode==="dungeon"&&t&&n.useFov&&(ie(t),se(t,n.player.pos,10));const e=n.player.baseAttack+he(n.player),o=n.player.baseDefense+ye(n.player);Ze.innerHTML=`
    <div class="kv"><div><b>${Z(n.player.name)}</b> <span class="muted">Lvl ${n.player.level}</span></div><div>HP ${n.player.hp}/${n.player.maxHp}</div></div>
    <div class="kv small"><div>Atk ${e}</div><div>Def ${o}</div></div>
    <div class="kv small"><div>XP ${n.player.xp}/${V(n.player.level)}</div><div>Gold ${n.player.gold}</div></div>
    <div class="kv small"><div>Pos ${n.player.pos.x}, ${n.player.pos.y}</div><div class="muted">Turn ${n.turnCounter}</div></div>
    <div class="kv small"><div class="muted">Status ${(n.player.statusEffects??[]).map(u=>u.kind+":"+u.remainingTurns).join(", ")||"none"}</div><div class="muted">Seed ${n.worldSeed}</div></div>
  `;const i=P()?B(n,n.player.pos):void 0;i&&(z(n,n.player.pos),U(n,i));const s=pe();if(ue.innerHTML=ze({mode:n.activePanel,player:n.player,items:n.items,activeShop:i,canShop:P(),quests:n.quests,activeTownId:s,shopCategory:n.shopCategory}),et.innerHTML=n.log.all().slice(0,160).map(u=>`<div>• ${Z(u.text)}</div>`).join(""),n.mapOpen){D.style.display="block",L.style.display="none";const u=n.destination??{x:n.player.pos.x+n.mapCursor.x,y:n.player.pos.y+n.mapCursor.y};D.textContent=Qe({overworld:n.overworld,player:n.player,destination:u,autoPath:n.autoPath,items:n.items},89,41);return}n.rendererMode==="ascii"?(D.style.display="block",L.style.display="none",D.textContent=De({mode:n.mode,overworld:n.overworld,dungeon:t,player:n.player,entities:n.entities,items:n.items,useFov:n.useFov},Xe,je)):(D.style.display="none",L.style.display="block",ut.render({mode:n.mode,overworld:n.overworld,dungeon:t,player:n.player,entities:n.entities,items:n.items,useFov:n.useFov},Math.floor(Y.width/16)-1,Math.floor(Y.height/16)-1))}ue.addEventListener("click",t=>{const e=t.target;if(!e)return;const o=e.getAttribute("data-act"),i=e.getAttribute("data-item"),s=e.getAttribute("data-quest");if(o){if(o==="use"){if(!i)return;Mt(i),v();return}if(o==="equipWeapon"){if(!i)return;At(i),v();return}if(o==="equipArmor"){if(!i)return;Rt(i),v();return}if(o==="drop"){if(!i)return;Tt(i),v();return}if(o==="buy"){if(!i)return;Et(i),v();return}if(o==="sell"){if(!i)return;Dt(i),v();return}if(o==="shopCat"){const r=e.getAttribute("data-cat");(r==="all"||r==="potion"||r==="weapon"||r==="armor")&&(n.shopCategory=r),v();return}if(o==="turnIn"){s&&Ct(s),v();return}}});function Mt(t){const e=n.items.find(s=>s.id===t);if(!e||e.kind!=="potion"||!n.player.inventory.includes(t))return;const o=e.healAmount??8,i=n.player.hp;n.player.hp=Math.min(n.player.maxHp,n.player.hp+o),n.player.inventory=n.player.inventory.filter(s=>s!==t),n.items=n.items.filter(s=>s.id!==t),n.log.push(`You drink ${e.name}. (+${n.player.hp-i} HP)`)}function At(t){const e=n.items.find(o=>o.id===t);!e||e.kind!=="weapon"||n.player.inventory.includes(t)&&(n.player.equipment.weaponItemId=t,n.log.push(`Equipped weapon: ${e.name}.`))}function Rt(t){const e=n.items.find(o=>o.id===t);!e||e.kind!=="armor"||n.player.inventory.includes(t)&&(n.player.equipment.armorItemId=t,n.log.push(`Equipped armor: ${e.name}.`))}function Tt(t){const e=n.items.find(o=>o.id===t);if(e&&n.player.inventory.includes(t)){if(n.mode==="dungeon"){const o=q(n);o&&(e.mapRef={kind:"dungeon",dungeonId:o.id},e.pos={x:n.player.pos.x,y:n.player.pos.y},n.log.push(`Dropped: ${e.name}.`))}else n.log.push(`Discarded: ${e.name}.`),n.items=n.items.filter(o=>o.id!==t);n.player.inventory=n.player.inventory.filter(o=>o!==t),n.player.equipment.weaponItemId===t&&(n.player.equipment.weaponItemId=void 0),n.player.equipment.armorItemId===t&&(n.player.equipment.armorItemId=void 0)}}function Et(t){if(!P()){n.log.push("You need to be in town to buy.");return}const e=n.items.find(i=>i.id===t);if(!e)return;const o=e.value;if(n.player.gold<o){n.log.push("Not enough gold.");return}n.player.gold-=o,n.player.inventory.push(e.id),n.log.push(`Bought: ${e.name} for ${o}g.`)}function Dt(t){if(!P()){n.log.push("You need to be in town to sell.");return}const e=n.items.find(i=>i.id===t);if(!e||!n.player.inventory.includes(t))return;const o=Math.max(1,Math.floor(e.value*.5));n.player.gold+=o,n.player.inventory=n.player.inventory.filter(i=>i!==t),n.player.equipment.weaponItemId===t&&(n.player.equipment.weaponItemId=void 0),n.player.equipment.armorItemId===t&&(n.player.equipment.armorItemId=void 0),n.items=n.items.filter(i=>i.id!==t),n.log.push(`Sold: ${e.name} for ${o}g.`)}function Ct(t){const e=pe();if(!e){n.log.push("You need to be in town to turn in quests.");return}const o=n.quests.find(i=>i.id===t);if(o){if(o.townId!==e){n.log.push("That quest belongs to another town.");return}if(!o.turnedIn){if(!o.completed){n.log.push("Quest is not complete yet.");return}o.turnedIn=!0,n.player.gold+=o.rewardGold,me(o.rewardXp),n.log.push(`Quest turned in! +${o.rewardGold}g and +${o.rewardXp} XP.`)}}}function Z(t){return t.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")}function _t(t){if(t.key==="r"||t.key==="R")return{kind:"toggleRenderer"};if(t.key==="f"||t.key==="F")return{kind:"toggleFov"};if(t.key==="?")return{kind:"help"};if(t.key==="p"||t.key==="P")return{kind:"save"};if(t.key==="o"||t.key==="O")return{kind:"load"};if(t.key==="i"||t.key==="I")return{kind:"toggleInventory"};if(t.key==="b"||t.key==="B")return{kind:"toggleShop"};if(t.key==="q"||t.key==="Q")return{kind:"toggleQuest"};if(t.key==="m"||t.key==="M")return{kind:"toggleMap"};if(t.key==="g"||t.key==="G"||t.key===",")return{kind:"pickup"};if(t.key==="Enter")return{kind:"use"};if(t.key==="c"||t.key==="C")return{kind:"cancelAuto"};if(t.key===" ")return{kind:"wait"};if(t.key==="ArrowUp"||t.key==="w"||t.key==="W")return{kind:"move",dx:0,dy:-1*(t.shiftKey?5:1)};if(t.key==="ArrowDown"||t.key==="s"||t.key==="S")return{kind:"move",dx:0,dy:1*(t.shiftKey?5:1)};if(t.key==="ArrowLeft"||t.key==="a"||t.key==="A")return{kind:"move",dx:-1*(t.shiftKey?5:1),dy:0};if(t.key==="ArrowRight"||t.key==="d"||t.key==="D")return{kind:"move",dx:1*(t.shiftKey?5:1),dy:0}}function Ft(t){if(t.key==="Escape"||t.key==="m"||t.key==="M"){n.mapOpen=!1,v();return}const e=t.shiftKey?5:1;if((t.key==="ArrowUp"||t.key==="w"||t.key==="W")&&(n.mapCursor.y-=e),(t.key==="ArrowDown"||t.key==="s"||t.key==="S")&&(n.mapCursor.y+=e),(t.key==="ArrowLeft"||t.key==="a"||t.key==="A")&&(n.mapCursor.x-=e),(t.key==="ArrowRight"||t.key==="d"||t.key==="D")&&(n.mapCursor.x+=e),(t.key==="c"||t.key==="C")&&(n.destination=void 0,n.autoPath=void 0,n.log.push("Auto-walk canceled.")),t.key==="Enter"){const o={x:n.player.pos.x+n.mapCursor.x,y:n.player.pos.y+n.mapCursor.y};Pt(o),n.mapOpen=!1}v()}window.addEventListener("keydown",t=>{if(n.mapOpen){t.preventDefault(),Ft(t);return}const e=_t(t);e&&(t.preventDefault(),fe(e))});tt.addEventListener("click",()=>{n.rendererMode="ascii",R(),v()});nt.addEventListener("click",()=>{n.rendererMode="canvas",R(),v()});ot.addEventListener("click",()=>{n=de(Date.now()&4294967295),R(),v()});it.addEventListener("click",()=>{ve(),v()});st.addEventListener("click",()=>{we(),R(),v()});rt.addEventListener("click",()=>{n.activePanel=n.activePanel==="inventory"?"none":"inventory",v()});at.addEventListener("click",()=>{n.activePanel=n.activePanel==="shop"?"none":"shop",n.activePanel==="shop"&&P()&&B(n,n.player.pos),v()});lt.addEventListener("click",()=>{fe({kind:"toggleMap"})});function ve(){var i;const t=[...n.dungeons.values()],e=[...n.shops.values()],o={version:3,worldSeed:n.worldSeed,mode:n.mode,playerId:n.player.id,entities:n.entities,items:n.items,dungeons:t,shops:e,entranceReturnPos:(i=n.dungeonStack[0])==null?void 0:i.entranceWorldPos,activePanel:n.activePanel,turnCounter:n.turnCounter,quests:n.quests};He(o),n.log.push("Saved.")}function we(){const t=Ye();if(!t){n.log.push("No save found.");return}const e=new S(t.worldSeed),o=new te(t.worldSeed),i=new Map;for(const u of t.dungeons)i.set(u.id,u);const s=new Map;for(const u of t.shops)s.set(u.id,u);const r=t.entities.find(u=>u.id===t.playerId);if(r&&!r.statusEffects&&(r.statusEffects=[]),!r){n.log.push("Save missing player.");return}n={worldSeed:t.worldSeed,rng:e,mode:t.mode,overworld:o,dungeons:i,dungeonStack:qt(t,r),player:r,entities:t.entities,items:t.items,shops:s,rendererMode:n.rendererMode,useFov:n.useFov,activePanel:t.activePanel??"none",shopCategory:"all",turnCounter:t.turnCounter??0,quests:t.quests??[],log:new ae(160)},n.log.push("Loaded.")}function qt(t,e){if(e.mapRef.kind!=="dungeon")return[];const o=t.dungeons.find(r=>r.id===e.mapRef.dungeonId);if(!o)return[];const i=t.entranceReturnPos??{x:0,y:0},s=[];for(let r=0;r<=o.depth;r++)s.push({baseId:o.baseId,depth:r,entranceWorldPos:i});return s}R();v();
